<%- include('../layout', { title: title || 'Pagamento Confirmado' }) %>

<div class="container mx-auto px-4 py-8">
  <div class="max-w-2xl mx-auto">
    <div class="bg-green-50 border-l-4 border-green-500 p-6 rounded-lg shadow-lg">
      <div class="flex items-center mb-4">
        <svg class="w-12 h-12 text-green-500 mr-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
        <h1 class="text-3xl font-bold text-green-700">Pagamento Confirmado!</h1>
      </div>

      <div class="bg-white p-6 rounded-lg mb-6">
        <p class="text-gray-700 mb-4">
          OlÃ¡, <strong><%= user.nome || 'Cliente' %></strong>!
        </p>
        <p class="text-gray-700 mb-4">
          Seu pagamento foi confirmado com sucesso.
        </p>

        <% if (cobranca) { %>
        <div class="bg-gray-50 p-4 rounded-lg mb-4">
          <h3 class="font-semibold text-gray-800 mb-2">Detalhes do Pagamento:</h3>
          <p class="text-gray-700"><strong>Valor:</strong> R$ <%= parseFloat(cobranca.valor).toFixed(2) %></p>
          <p class="text-gray-700"><strong>Data de Pagamento:</strong> <%= cobranca.data_pagamento ? new Date(cobranca.data_pagamento).toLocaleDateString('pt-BR') : 'N/A' %></p>
          <p class="text-gray-700"><strong>MÃªs de ReferÃªncia:</strong> <%= cobranca.mes_referencia %></p>
        </div>
        <% } %>

        <% 
        // Debug: verifica condiÃ§Ãµes para exibir formulÃ¡rio
        const deveExibirFormulario = !userHasPassword && tokenCadastro;
        console.log('ðŸ” [Frontend] CondiÃ§Ãµes para formulÃ¡rio:', {
          userHasPassword: typeof userHasPassword !== 'undefined' ? userHasPassword : 'undefined',
          tokenCadastro: typeof tokenCadastro !== 'undefined' && tokenCadastro ? 'existe' : 'nÃ£o existe',
          deveExibirFormulario: deveExibirFormulario
        });
        %>

        <% if (!userHasPassword && tokenCadastro) { %>
        <!-- FORMULÃRIO DE CRIAÃ‡ÃƒO DE SENHA -->
        <div class="bg-blue-50 border-l-4 border-blue-500 p-6 rounded-lg mb-6">
          <h2 class="text-xl font-bold text-blue-800 mb-4">
            <i class="fas fa-key mr-2"></i>Complete seu Cadastro
          </h2>
          <p class="text-gray-700 mb-4">
            Para acessar o sistema, vocÃª precisa criar uma senha. Preencha os dados abaixo:
          </p>

          <% if (typeof error !== 'undefined' && error) { %>
          <div class="bg-red-50 border-l-4 border-red-500 p-4 rounded mb-4">
            <div class="flex items-center">
              <i class="fas fa-exclamation-circle text-red-500 mr-2"></i>
              <p class="text-red-700 text-sm"><%= error %></p>
            </div>
          </div>
          <% } %>

          <form method="POST" action="/cadastro/<%= typeof tokenCadastro !== 'undefined' && tokenCadastro ? tokenCadastro : '' %>" class="space-y-4">
            <input type="hidden" name="token" value="<%= typeof tokenCadastro !== 'undefined' && tokenCadastro ? tokenCadastro : '' %>">
            
            <div>
              <label for="nome" class="block text-sm font-semibold text-gray-700 mb-2">
                <i class="fas fa-user text-primary-red mr-2"></i>Nome Completo
              </label>
              <input type="text" id="nome" name="nome" required
                  value="<%= typeof user !== 'undefined' && user && user.nome ? user.nome : '' %>"
                  class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-red focus:border-primary-red transition-all shadow-sm hover:border-gray-400"
                  placeholder="Digite seu nome completo">
            </div>

            <div>
              <label for="email" class="block text-sm font-semibold text-gray-700 mb-2">
                <i class="fas fa-envelope text-primary-red mr-2"></i>Email
              </label>
              <input type="email" id="email" name="email" required
                  value="<%= typeof user !== 'undefined' && user && user.email ? user.email : '' %>"
                  readonly
                  class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg bg-gray-50 text-gray-600 cursor-not-allowed">
              <p class="text-xs text-gray-500 mt-1">Este email estÃ¡ vinculado Ã  sua assinatura</p>
            </div>

            <div>
              <label for="senha" class="block text-sm font-semibold text-gray-700 mb-2">
                <i class="fas fa-lock text-primary-red mr-2"></i>Senha
              </label>
              <input type="password" id="senha" name="senha" required minlength="6"
                  class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-red focus:border-primary-red transition-all shadow-sm hover:border-gray-400"
                  placeholder="MÃ­nimo 6 caracteres">
              <p class="text-xs text-gray-500 mt-1 flex items-center">
                <i class="fas fa-info-circle mr-1"></i>MÃ­nimo de 6 caracteres
              </p>
            </div>

            <div>
              <label for="confirmarSenha" class="block text-sm font-semibold text-gray-700 mb-2">
                <i class="fas fa-lock text-primary-red mr-2"></i>Confirmar Senha
              </label>
              <input type="password" id="confirmarSenha" name="confirmarSenha" required minlength="6"
                  class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-red focus:border-primary-red transition-all shadow-sm hover:border-gray-400"
                  placeholder="Digite a senha novamente">
            </div>

            <button type="submit"
                class="w-full bg-gradient-to-r from-green-600 to-green-700 text-white py-3 rounded-lg font-bold text-lg hover:opacity-90 transition-all shadow-lg hover:shadow-xl transform hover:scale-[1.02] active:scale-[0.98]">
              <i class="fas fa-check-circle mr-2"></i>Criar Senha e Acessar Sistema
            </button>
          </form>
        </div>
        <% } else { %>
        <!-- USUÃRIO JÃ TEM SENHA - MOSTRA BOTÃƒO PARA DASHBOARD -->
        <div class="text-center">
          <a href="/dashboard" 
             class="inline-block bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg transition duration-200">
            <i class="fas fa-arrow-right mr-2"></i>Acessar Dashboard
          </a>
        </div>
        <% } %>
      </div>
    </div>
  </div>
</div>

<%- include('../partials/footer') %>

<script>
  // ValidaÃ§Ã£o de senha no frontend
  document.querySelector('form')?.addEventListener('submit', function(e) {
    const senha = document.getElementById('senha')?.value;
    const confirmarSenha = document.getElementById('confirmarSenha')?.value;
    
    if (senha && confirmarSenha && senha !== confirmarSenha) {
      e.preventDefault();
      alert('As senhas nÃ£o coincidem. Por favor, verifique e tente novamente.');
      return false;
    }
    
    if (senha && senha.length < 6) {
      e.preventDefault();
      alert('A senha deve ter pelo menos 6 caracteres.');
      return false;
    }
  });
</script>

