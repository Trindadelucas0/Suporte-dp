<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>
        <%= title %>
    </title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: { red: '#DC2626', yellow: '#FBBF24' }
                    }
                }
            }
        }
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bungee+Inline&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .bungee-inline-regular {
            font-family: "Bungee Inline", sans-serif;
            font-weight: 400;
            font-style: normal;
        }
        .border-3 {
            border-width: 3px !important;
        }
    </style>
</head>

<body class="bg-gradient-to-br from-gray-50 via-red-50 to-yellow-50 min-h-screen">
    <% if (typeof user !=='undefined' && user) { %>
        <%- include('../partials/navbar') %>
            <% } %>

                <main class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
                    <div class="mb-6">
                        <h1 class="text-3xl font-bold text-gray-900">Calendário de Obrigações</h1>
                        <p class="mt-2 text-gray-600">Gerencie feriados, obrigações fiscais e anotações</p>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
                        <!-- Calendário Principal -->
                        <div class="lg:col-span-3">
                            <div class="bg-white rounded-xl shadow-xl p-4 sm:p-6 border-4 border-primary-red hover:border-primary-yellow transition-all duration-300 transform hover:shadow-2xl">
                                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 sm:mb-6 gap-3 sm:gap-0">
                                    <h2 class="text-xl sm:text-2xl font-bold capitalize bg-gradient-to-r from-primary-red to-primary-yellow bg-clip-text text-transparent">
                                        <i class="fas fa-calendar-alt text-primary-red mr-2"></i>
                                        <%= mesNome %>
                                            <%= ano %>
                                    </h2>
                                    <div class="flex space-x-2">
                                        <a href="?ano=<%= mes === 1 ? ano - 1 : ano %>&mes=<%= mes === 1 ? 12 : mes - 1 %>"
                                            class="px-3 sm:px-4 py-2 bg-gradient-to-r from-gray-100 to-gray-200 rounded-lg hover:from-primary-red hover:to-primary-yellow hover:text-white transition-all duration-300 transform hover:scale-105 shadow-md hover:shadow-lg font-semibold text-sm sm:text-base">
                                            <i class="fas fa-chevron-left"></i> <span class="hidden sm:inline">Anterior</span>
                                        </a>
                                        <a href="?ano=<%= mes === 12 ? ano + 1 : ano %>&mes=<%= mes === 12 ? 1 : mes + 1 %>"
                                            class="px-3 sm:px-4 py-2 bg-gradient-to-r from-gray-100 to-gray-200 rounded-lg hover:from-primary-red hover:to-primary-yellow hover:text-white transition-all duration-300 transform hover:scale-105 shadow-md hover:shadow-lg font-semibold text-sm sm:text-base">
                                            <span class="hidden sm:inline">Próximo</span> <i class="fas fa-chevron-right"></i>
                                        </a>
                                        <a href="?ano=<%= new Date().getFullYear() %>&mes=<%= new Date().getMonth() + 1 %>"
                                            class="px-3 sm:px-4 py-2 bg-gradient-to-r from-primary-red to-primary-yellow text-white rounded-lg hover:from-primary-yellow hover:to-primary-red transition-all duration-300 transform hover:scale-105 shadow-md hover:shadow-lg font-semibold text-sm sm:text-base">
                                            <i class="fas fa-calendar-day mr-1"></i> Hoje
                                        </a>
                                    </div>
                                </div>

                                <!-- Cabeçalho dos dias da semana -->
                                <div class="grid grid-cols-7 gap-2 mb-2">
                                    <div class="text-center font-bold text-white py-2 sm:py-3 bg-gradient-to-br from-red-500 to-red-600 rounded-lg shadow-md text-xs sm:text-sm">Dom</div>
                                    <div class="text-center font-bold text-white py-2 sm:py-3 bg-gradient-to-br from-gray-600 to-gray-700 rounded-lg shadow-md text-xs sm:text-sm">Seg</div>
                                    <div class="text-center font-bold text-white py-2 sm:py-3 bg-gradient-to-br from-gray-600 to-gray-700 rounded-lg shadow-md text-xs sm:text-sm">Ter</div>
                                    <div class="text-center font-bold text-white py-2 sm:py-3 bg-gradient-to-br from-gray-600 to-gray-700 rounded-lg shadow-md text-xs sm:text-sm">Qua</div>
                                    <div class="text-center font-bold text-white py-2 sm:py-3 bg-gradient-to-br from-gray-600 to-gray-700 rounded-lg shadow-md text-xs sm:text-sm">Qui</div>
                                    <div class="text-center font-bold text-white py-2 sm:py-3 bg-gradient-to-br from-gray-600 to-gray-700 rounded-lg shadow-md text-xs sm:text-sm">Sex</div>
                                    <div class="text-center font-bold text-white py-2 sm:py-3 bg-gradient-to-br from-yellow-500 to-yellow-600 rounded-lg shadow-md text-xs sm:text-sm">Sáb</div>
                                </div>

                                <!-- Dias do mês -->
                                <div class="grid grid-cols-7 gap-2">
                                    <% const primeiroDia=new Date(ano, mes - 1, 1).getDay(); for (let i=0; i <
                                        primeiroDia; i++) { %>
                                        <div class="h-24"></div>
                                        <% } %>

                                            <% if (typeof calendario !=='undefined' && calendario && calendario.length>
                                                0) { %>
                                                <% calendario.forEach(dia=> { %>
                                                    <div data-dia="<%= dia.data %>" class="dia-calendario min-h-20 sm:min-h-24 border-3 rounded-lg p-1 sm:p-2 cursor-pointer transition-all duration-300 transform hover:scale-105 hover:shadow-xl hover:z-10
                                        <%= dia.isFeriado && dia.feriadoTipo === 'nacional' ? 'bg-gradient-to-br from-red-400 to-red-500 border-red-700 hover:border-red-800 hover:from-red-500 hover:to-red-600' : 
                                            dia.isFeriado && dia.feriadoTipo === 'facultativo' ? 'bg-gradient-to-br from-orange-300 to-orange-400 border-orange-600 hover:border-orange-700 hover:from-orange-400 hover:to-orange-500' :
                                            dia.diaSemana === 0 ? 'bg-gradient-to-br from-gray-200 to-gray-300 border-gray-400 hover:border-gray-500' :
                                            dia.anotacao || (dia.obrigacoes && dia.obrigacoes.length > 0) || (dia.tarefas && dia.tarefas.length > 0) ? 'bg-gradient-to-br from-yellow-300 to-yellow-400 border-yellow-600 hover:border-yellow-700 hover:from-yellow-400 hover:to-yellow-500' : 
                                            'bg-gradient-to-br from-white to-gray-50 border-gray-300 hover:border-primary-red hover:from-primary-red hover:to-primary-yellow hover:text-white' %>">
                                                        <div class="flex justify-between items-start mb-1">
                                                            <span
                                                                class="text-base sm:text-lg font-bold <%= dia.isFeriado && dia.feriadoTipo === 'nacional' ? 'text-red-900' : dia.isFeriado && dia.feriadoTipo === 'facultativo' ? 'text-orange-900' : dia.diaSemana === 0 ? 'text-gray-800' : 'text-gray-900' %> dia-numero">
                                                                <%= typeof dia.dia !=='undefined' ? dia.dia : '' %>
                                                            </span>
                                                            <% 
                                                                const totalEventos = (dia.obrigacoes ? dia.obrigacoes.length : 0) + (dia.tarefas ? dia.tarefas.length : 0);
                                                            %>
                                                            <% if (totalEventos > 0) { %>
                                                                <span
                                                                    class="text-xs sm:text-sm bg-gradient-to-r from-primary-yellow to-primary-red text-white px-1.5 sm:px-2 py-0.5 rounded-full font-bold shadow-md transform hover:scale-110 transition-transform">
                                                                    <%= totalEventos %>
                                                                </span>
                                                            <% } %>
                                                        </div>

                                                        <% if (dia.isFeriado) { %>
                                                            <div class="text-xs <%= dia.feriadoTipo === 'facultativo' ? 'text-orange-900' : 'text-red-900' %> font-bold truncate"
                                                                title="<%= dia.feriadoNome %> (<%= dia.feriadoTipo === 'facultativo' ? 'Ponto Facultativo' : 'Feriado Nacional' %>)">
                                                                <i class="fas fa-<%= dia.feriadoTipo === 'facultativo' ? 'calendar-check' : 'calendar-times' %> mr-1"></i>
                                                                <%= dia.feriadoNome %>
                                                                <% if (dia.feriadoTipo === 'facultativo') { %>
                                                                    <span class="text-xs opacity-75">(Facultativo)</span>
                                                                <% } %>
                                                            </div>
                                                            <% } %>

                                                                <% if (dia.obrigacoes && dia.obrigacoes.length> 0) { %>
                                                                    <div class="space-y-1 mt-1">
                                                                        <% dia.obrigacoes.slice(0,
                                                                            2).forEach(obrigacao=> { %>
                                                                            <div class="text-xs <%= obrigacao.tipo === 'fgts' ? 'text-orange-700 bg-orange-100' : obrigacao.tipo === 'inss' ? 'text-green-700 bg-green-100' : obrigacao.tipo === 'irrf' ? 'text-purple-700 bg-purple-100' : obrigacao.tipo === 'dctfweb' ? 'text-blue-700 bg-blue-100' : obrigacao.tipo === 'efd_reinf' ? 'text-indigo-700 bg-indigo-100' : 'text-gray-700 bg-gray-100' %> px-1 py-0.5 rounded truncate"
                                                                                title="<%= obrigacao.descricao %>">
                                                                                <i
                                                                                    class="fas fa-<%= obrigacao.tipo === 'fgts' ? 'wallet' : obrigacao.tipo === 'inss' ? 'shield-alt' : obrigacao.tipo === 'irrf' ? 'receipt' : obrigacao.tipo === 'dctfweb' ? 'file-invoice' : obrigacao.tipo === 'efd_reinf' ? 'file-alt' : 'calendar-check' %> mr-1"></i>
                                                                                <%= obrigacao.descricao %>
                                                                            </div>
                                                                            <% }); %>
                                                                                <% if (dia.obrigacoes.length> 2) { %>
                                                                                    <div class="text-xs text-gray-600">
                                                                                        +<%= dia.obrigacoes.length - 2
                                                                                            %> mais
                                                                                    </div>
                                                                                    <% } %>
                                                                    </div>
                                                                    <% } %>

                                                                        <% if (dia.tarefas && dia.tarefas.length > 0) { %>
                                                                            <div class="space-y-1 mt-1">
                                                                                <% dia.tarefas.slice(0, 2).forEach(tarefa => { %>
                                                                                    <% 
                                                                                        const corTipo = tarefa.tipo === 'FÉRIAS' ? 'text-blue-900 bg-blue-300 border border-blue-500 font-semibold' :
                                                                                                       tarefa.tipo === '13° ADIANTAMENTO' || tarefa.tipo === '13° INTEGRAL' ? 'text-orange-900 bg-orange-300 border border-orange-500 font-semibold' :
                                                                                                       tarefa.tipo === 'RESCISÃO' ? 'text-red-900 bg-red-300 border border-red-500 font-semibold' :
                                                                                                       tarefa.tipo === 'ADMISSÃO' ? 'text-green-900 bg-green-300 border border-green-500 font-semibold' :
                                                                                                       tarefa.tipo === 'AFASTAMENTO' ? 'text-yellow-900 bg-yellow-300 border border-yellow-500 font-semibold' :
                                                                                                       tarefa.tipo === 'ALTERAÇÃO SALARIAL' ? 'text-purple-900 bg-purple-300 border border-purple-500 font-semibold' :
                                                                                                       tarefa.tipo === 'ALTERAÇÃO DE CARGO' ? 'text-indigo-900 bg-indigo-300 border border-indigo-500 font-semibold' :
                                                                                                       tarefa.prioridade === 'alta' ? 'text-red-900 bg-red-300 border border-red-500 font-semibold' :
                                                                                                       tarefa.prioridade === 'media' ? 'text-yellow-900 bg-yellow-300 border border-yellow-500 font-semibold' :
                                                                                                       'text-green-900 bg-green-300 border border-green-500 font-semibold';
                                                                                        const concluida = tarefa.status === 'feito';
                                                                                    %>
                                                                                    <a href="/tarefas?id=<%= tarefa.id %>" 
                                                                                       class="block text-xs <%= corTipo %> px-2 py-1 rounded-md truncate <%= concluida ? 'opacity-60 line-through' : '' %> hover:opacity-100 hover:shadow-md transition-all"
                                                                                       title="<%= tarefa.nome %>">
                                                                                        <i class="fas fa-<%= concluida ? 'check-circle' : 'tasks' %> mr-1"></i>
                                                                                        <%= tarefa.nome %>
                                                                                    </a>
                                                                                <% }); %>
                                                                                <% if (dia.tarefas.length > 2) { %>
                                                                                    <div class="text-xs text-gray-600">
                                                                                        +<%= dia.tarefas.length - 2 %> tarefas
                                                                                    </div>
                                                                                <% } %>
                                                                            </div>
                                                                        <% } %>

                                                                        <% if (dia.anotacao) { %>
                                                                            <div class="text-xs text-yellow-700 mt-1 truncate"
                                                                                title="<%= dia.anotacao %>">
                                                                                <i
                                                                                    class="fas fa-sticky-note mr-1"></i>Anotação
                                                                            </div>
                                                                            <% } %>
                                                    </div>
                                                    <% }); %>
                                                        <% } else { %>
                                                            <div class="col-span-7 text-center py-8 text-gray-500">
                                                                <i class="fas fa-calendar-times text-4xl mb-2"></i>
                                                                <p>Carregando calendário...</p>
                                                                <p class="text-xs mt-2">Se os dias não aparecerem,
                                                                    verifique o console do servidor</p>
                                                            </div>
                                                            <% } %>
                                </div>
                            </div>
                        </div>

                        <!-- Painel Lateral -->
                        <div class="lg:col-span-1 space-y-4 sm:space-y-6">
                            <!-- Calcular Dias Úteis -->
                            <div class="bg-white rounded-xl shadow-xl p-4 sm:p-6 border-2 border-primary-yellow hover:border-primary-red transition-all duration-300 transform hover:shadow-2xl">
                                <h3 class="text-lg font-bold mb-4">
                                    <i class="fas fa-calculator text-primary-red mr-2"></i>
                                    Calcular Dias Úteis
                                </h3>
                                <form id="formDiasUteis" class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium mb-2">Data Início</label>
                                        <input type="date" id="dataInicio"
                                            class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-primary-red">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium mb-2">Data Fim</label>
                                        <input type="date" id="dataFim"
                                            class="w-full px-3 py-2 border rounded focus:ring-2 focus:ring-primary-red">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium mb-2">Tipo de Semana</label>
                                        <select id="tipoSemana" class="w-full px-3 py-2 border rounded">
                                            <option value="segunda_sexta">Segunda a Sexta</option>
                                            <option value="segunda_sabado">Segunda a Sábado</option>
                                        </select>
                                    </div>
                                    <button type="submit"
                                        class="w-full bg-gradient-to-r from-primary-red to-primary-yellow text-white py-2 rounded-lg hover:from-primary-yellow hover:to-primary-red transition-all duration-300 transform hover:scale-105 shadow-md hover:shadow-lg font-semibold">
                                        <i class="fas fa-calculator mr-2"></i>Calcular
                                    </button>
                                </form>
                                <div id="resultadoDiasUteis" class="mt-4 hidden"></div>
                            </div>

                            <!-- Legenda -->
                            <div class="bg-white rounded-xl shadow-xl p-4 sm:p-6 border-2 border-primary-yellow hover:border-primary-red transition-all duration-300 transform hover:shadow-2xl">
                                <h3 class="text-lg font-bold mb-4">
                                    <i class="fas fa-info-circle text-primary-yellow mr-2"></i>
                                    Legenda
                                </h3>
                                <div class="space-y-2 text-sm">
                                    <div class="flex items-center p-2 rounded-lg hover:bg-red-50 transition-colors cursor-pointer">
                                        <div class="w-5 h-5 bg-gradient-to-br from-red-400 to-red-500 border-3 border-red-700 rounded mr-2 shadow-md"></div>
                                        <span class="font-semibold text-gray-900">Feriado Nacional</span>
                                    </div>
                                    <div class="flex items-center p-2 rounded-lg hover:bg-orange-50 transition-colors cursor-pointer">
                                        <div class="w-5 h-5 bg-gradient-to-br from-orange-300 to-orange-400 border-3 border-orange-600 rounded mr-2 shadow-md"></div>
                                        <span class="font-semibold text-gray-900">Ponto Facultativo</span>
                                    </div>
                                    <div class="flex items-center p-2 rounded-lg hover:bg-yellow-50 transition-colors cursor-pointer">
                                        <div class="w-5 h-5 bg-gradient-to-br from-yellow-300 to-yellow-400 border-3 border-yellow-600 rounded mr-2 shadow-md"></div>
                                        <span class="font-semibold text-gray-900">Obrigações/Anotações</span>
                                    </div>
                                    <div class="flex items-center p-2 rounded-lg hover:bg-gray-50 transition-colors cursor-pointer">
                                        <div class="w-5 h-5 bg-gradient-to-br from-gray-200 to-gray-300 border-3 border-gray-400 rounded mr-2 shadow-sm"></div>
                                        <span class="font-semibold text-gray-900">Domingo</span>
                                    </div>
                                    <div class="flex items-center p-2 rounded-lg hover:bg-gray-50 transition-colors cursor-pointer">
                                        <div class="w-5 h-5 bg-gradient-to-br from-white to-gray-50 border-3 border-gray-300 rounded mr-2 shadow-md"></div>
                                        <span class="font-semibold text-gray-900">Dia Útil</span>
                                    </div>
                                </div>
                            </div>

                            <!-- DSR -->
                            <div class="bg-yellow-50 border-l-4 border-yellow-400 rounded-lg p-4">
                                <h4 class="font-bold mb-2 text-yellow-900">
                                    <i class="fas fa-info-circle mr-2"></i>
                                    DSR - Descanso Semanal Remunerado
                                </h4>
                                <p class="text-sm text-yellow-800">
                                    O DSR é calculado sobre horas extras e comissões.
                                    Considere domingos e feriados no cálculo.
                                </p>
                            </div>
                        </div>
                    </div>
                </main>

                <!-- Modal de Anotação e Obrigações -->
                <div id="modalAnotacao"
                    class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
                    <div class="bg-white rounded-lg p-6 max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-bold">Data: <span id="modalData"></span></h3>
                            <button type="button" id="btnFecharModal" class="text-gray-500 hover:text-gray-700">
                                <i class="fas fa-times text-2xl"></i>
                            </button>
                        </div>

                        <!-- Abas -->
                        <div class="border-b mb-4">
                            <nav class="flex -mb-px">
                                <button type="button" data-aba="anotacao" id="tab-anotacao"
                                    class="px-4 py-2 border-b-2 border-primary-red text-primary-red font-semibold">
                                    <i class="fas fa-sticky-note mr-2"></i>Anotação
                                </button>
                                <button type="button" data-aba="obrigacoes" id="tab-obrigacoes"
                                    class="px-4 py-2 border-b-2 border-transparent text-gray-500 hover:text-gray-700">
                                    <i class="fas fa-calendar-check mr-2"></i>Obrigações
                                </button>
                            </nav>
                        </div>

                        <!-- Aba Anotação -->
                        <div id="content-anotacao" class="tab-content">
                            <textarea id="modalTexto" class="w-full px-3 py-2 border rounded mb-4" rows="4"
                                placeholder="Digite sua anotação para esta data..."></textarea>
                            <div class="flex justify-end space-x-2">
                                <button type="button" id="btnCancelarAnotacao"
                                    class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300">Cancelar</button>
                                <button type="button" id="btnSalvarAnotacao"
                                    class="px-4 py-2 bg-primary-red text-white rounded hover:bg-red-700">
                                    <i class="fas fa-save mr-2"></i>Salvar Anotação
                                </button>
                            </div>
                        </div>

                        <!-- Aba Obrigações -->
                        <div id="content-obrigacoes" class="tab-content hidden">
                            <div class="mb-4 bg-gray-50 p-4 rounded">
                                <h4 class="font-bold mb-3">Adicionar Nova Obrigação</h4>
                                <div class="space-y-3">
                                    <div>
                                        <label class="block text-sm font-medium mb-1">Tipo de Obrigação</label>
                                        <select id="tipoObrigacao" class="w-full px-3 py-2 border rounded">
                                            <option value="fgts">FGTS</option>
                                            <option value="inss">INSS</option>
                                            <option value="irrf">IRRF</option>
                                            <option value="dctfweb">DCTFWeb</option>
                                            <option value="efd_reinf">EFD-Reinf</option>
                                            <option value="esocial">eSocial</option>
                                            <option value="outro">Outro</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium mb-1">Descrição</label>
                                        <input type="text" id="descricaoObrigacao" placeholder="Ex: Vencimento DCTFWeb"
                                            class="w-full px-3 py-2 border rounded">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium mb-1">Observação (opcional)</label>
                                        <textarea id="observacaoObrigacao" placeholder="Observações adicionais..."
                                            class="w-full px-3 py-2 border rounded" rows="2"></textarea>
                                    </div>
                                    <button type="button" id="btnAdicionarObrigacao"
                                        class="w-full bg-primary-yellow text-white py-2 rounded hover:bg-yellow-600 font-semibold">
                                        <i class="fas fa-plus mr-2"></i>Adicionar Obrigação
                                    </button>
                                </div>
                            </div>

                            <div id="listaObrigacoes" class="space-y-2 mb-4">
                                <p class="text-sm text-gray-500 text-center py-4">Carregando obrigações...</p>
                            </div>

                            <div class="flex justify-end">
                                <button type="button" id="btnFecharModalObrigacoes"
                                    class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300">Fechar</button>
                            </div>
                        </div>
                    </div>
                </div>

                <script>
                    // Disponibiliza token CSRF globalmente (deve vir primeiro)
                    window.csrfToken = '<%= typeof csrfToken !== "undefined" && csrfToken ? csrfToken : "" %>';

                    // Função helper para adicionar CSRF em requisições fetch
                    function getCSRFHeaders() {
                        const headers = { 'Content-Type': 'application/json' };
                        if (window.csrfToken) {
                            headers['X-CSRF-Token'] = window.csrfToken;
                        }
                        return headers;
                    }

                    let dataSelecionada = '';
                    let obrigacoesAtuais = [];

                    function abrirModal(data) {
                        dataSelecionada = data;
                        const dataFormatada = new Date(data + 'T00:00:00').toLocaleDateString('pt-BR', {
                            weekday: 'long',
                            year: 'numeric',
                            month: 'long',
                            day: 'numeric'
                        });
                        document.getElementById('modalData').textContent = dataFormatada;
                        document.getElementById('modalAnotacao').classList.remove('hidden');
                        mostrarAba('anotacao');

                        // Carrega anotação
                        fetch('/calendario/anotacao/' + data)
                            .then(r => r.json())
                            .then(result => {
                                if (result.data && result.data.anotacao) {
                                    document.getElementById('modalTexto').value = result.data.anotacao;
                                } else {
                                    document.getElementById('modalTexto').value = '';
                                }
                            })
                            .catch(() => {
                                document.getElementById('modalTexto').value = '';
                            });

                        // Carrega obrigações
                        carregarObrigacoes(data);
                    }

                    function fecharModal() {
                        document.getElementById('modalAnotacao').classList.add('hidden');
                        obrigacoesAtuais = [];
                    }

                    function mostrarAba(aba) {
                        document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
                        document.querySelectorAll('[id^="tab-"]').forEach(b => {
                            b.classList.remove('border-primary-red', 'text-primary-red', 'font-semibold');
                            b.classList.add('border-transparent', 'text-gray-500');
                        });

                        document.getElementById('content-' + aba).classList.remove('hidden');
                        const btn = document.getElementById('tab-' + aba);
                        btn.classList.add('border-primary-red', 'text-primary-red', 'font-semibold');
                        btn.classList.remove('border-transparent', 'text-gray-500');
                    }

                    function carregarObrigacoes(data) {
                        fetch(`/calendario/obrigacoes?data=${data}`)
                            .then(r => r.json())
                            .then(result => {
                                obrigacoesAtuais = result.data || [];
                                atualizarListaObrigacoes();
                            })
                            .catch(() => {
                                obrigacoesAtuais = [];
                                atualizarListaObrigacoes();
                            });
                    }

                    function atualizarListaObrigacoes() {
                        const lista = document.getElementById('listaObrigacoes');
                        if (obrigacoesAtuais.length === 0) {
                            lista.innerHTML = '<p class="text-sm text-gray-500 text-center py-4">Nenhuma obrigação cadastrada para esta data</p>';
                            return;
                        }

                        lista.innerHTML = obrigacoesAtuais.map(obrigacao => {
                            const cores = {
                                'fgts': 'bg-orange-100 text-orange-700 border-orange-300',
                                'inss': 'bg-green-100 text-green-700 border-green-300',
                                'irrf': 'bg-purple-100 text-purple-700 border-purple-300',
                                'dctfweb': 'bg-blue-100 text-blue-700 border-blue-300',
                                'efd_reinf': 'bg-indigo-100 text-indigo-700 border-indigo-300',
                                'esocial': 'bg-teal-100 text-teal-700 border-teal-300',
                                'outro': 'bg-gray-100 text-gray-700 border-gray-300'
                            };
                            const cor = cores[obrigacao.tipo] || cores['outro'];

                            return `
                    <div class="border rounded p-3 ${cor}">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <p class="font-semibold text-sm">${obrigacao.descricao}</p>
                                <p class="text-xs opacity-75 mt-1">${obrigacao.tipo.toUpperCase()}</p>
                                ${obrigacao.observacao ? `<p class="text-xs mt-2 opacity-90">${obrigacao.observacao}</p>` : ''}
                            </div>
                            <button type="button" class="btn-remover-obrigacao text-red-600 hover:text-red-800 ml-2" data-obrigacao-id="${obrigacao.id}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
                        }).join('');
                    }

                    function adicionarObrigacao() {
                        const tipo = document.getElementById('tipoObrigacao').value;
                        const descricao = document.getElementById('descricaoObrigacao').value.trim();
                        const observacao = document.getElementById('observacaoObrigacao').value.trim();

                        if (!descricao) {
                            alert('Digite uma descrição para a obrigação');
                            return;
                        }

                        fetch('/calendario/obrigacao', {
                            method: 'POST',
                            headers: getCSRFHeaders(),
                            body: JSON.stringify({
                                data: dataSelecionada,
                                tipo,
                                descricao,
                                observacao: observacao || null,
                                _csrf: window.csrfToken
                            })
                        })
                            .then(r => r.json())
                            .then(result => {
                                if (result.success) {
                                    document.getElementById('descricaoObrigacao').value = '';
                                    document.getElementById('observacaoObrigacao').value = '';
                                    carregarObrigacoes(dataSelecionada);
                                } else {
                                    alert('Erro ao adicionar obrigação: ' + (result.error || 'Erro desconhecido'));
                                }
                            })
                            .catch(error => {
                                console.error('Erro:', error);
                                alert('Erro ao adicionar obrigação. Tente novamente.');
                            });
                    }

                    function removerObrigacao(id) {
                        if (!confirm('Deseja remover esta obrigação?')) return;

                        fetch(`/calendario/obrigacao/${id}`, {
                            method: 'DELETE',
                            headers: getCSRFHeaders(),
                            body: JSON.stringify({ _csrf: window.csrfToken })
                        })
                            .then(r => r.json())
                            .then(result => {
                                if (result.success) {
                                    carregarObrigacoes(dataSelecionada);
                                } else {
                                    alert('Erro ao remover obrigação');
                                }
                            })
                            .catch(error => {
                                console.error('Erro:', error);
                                alert('Erro ao remover obrigação. Tente novamente.');
                            });
                    }

                    function salvarAnotacao() {
                        if (!dataSelecionada) {
                            alert('Nenhuma data selecionada');
                            return;
                        }

                        const texto = document.getElementById('modalTexto').value;

                        fetch('/calendario/anotacao', {
                            method: 'POST',
                            headers: getCSRFHeaders(),
                            body: JSON.stringify({
                                data: dataSelecionada,
                                anotacao: texto || ''
                            })
                        })
                            .then(r => {
                                if (!r.ok) {
                                    return r.json().then(err => {
                                        throw new Error(err.error || 'Erro ao salvar');
                                    });
                                }
                                return r.json();
                            })
                            .then(result => {
                                if (result.success) {
                                    fecharModal();
                                    location.reload();
                                } else {
                                    alert('Erro ao salvar anotação: ' + (result.error || 'Erro desconhecido'));
                                }
                            })
                            .catch(error => {
                                console.error('Erro:', error);
                                alert('Erro ao salvar anotação: ' + error.message);
                            });
                    }

                    document.getElementById('formDiasUteis').addEventListener('submit', function (e) {
                        e.preventDefault();
                        const inicio = document.getElementById('dataInicio').value;
                        const fim = document.getElementById('dataFim').value;
                        const tipo = document.getElementById('tipoSemana').value;

                        if (!inicio || !fim) {
                            alert('Preencha ambas as datas');
                            return;
                        }

                        fetch(`/calendario/calcular?dataInicio=${inicio}&dataFim=${fim}&tipoSemana=${tipo}`)
                            .then(r => r.json())
                            .then(data => {
                                if (data.error) {
                                    alert('Erro: ' + data.error);
                                    return;
                                }

                                const div = document.getElementById('resultadoDiasUteis');
                                div.classList.remove('hidden');
                                
                                // Calcula dias não úteis
                                const diasNaoUteis = data.totalDias - data.diasUteis;
                                
                                div.innerHTML = `
                        <div class="bg-gradient-to-br from-green-50 to-blue-50 border-2 border-green-300 rounded-lg p-4 sm:p-6 shadow-lg">
                            <p class="font-bold text-gray-800 mb-4 text-lg">
                                <i class="fas fa-check-circle text-green-600 mr-2"></i>Resultado
                            </p>
                            
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                                <!-- Dias Úteis -->
                                <div class="bg-gradient-to-br from-green-100 to-green-200 border-2 border-green-500 rounded-lg p-3 sm:p-4 shadow-md">
                                    <p class="text-xs sm:text-sm text-green-800 font-semibold mb-1">
                                        <i class="fas fa-calendar-check mr-1"></i>Dias Úteis
                                    </p>
                                    <p class="text-2xl sm:text-3xl font-bold text-green-700">${data.diasUteis}</p>
                                </div>
                                
                                <!-- Dias Não Úteis -->
                                <div class="bg-gradient-to-br from-red-100 to-red-200 border-2 border-red-500 rounded-lg p-3 sm:p-4 shadow-md">
                                    <p class="text-xs sm:text-sm text-red-800 font-semibold mb-1">
                                        <i class="fas fa-calendar-times mr-1"></i>Dias Não Úteis
                                    </p>
                                    <p class="text-2xl sm:text-3xl font-bold text-red-700">${diasNaoUteis}</p>
                                </div>
                            </div>
                            
                            <div class="mt-4 pt-4 border-t border-gray-300">
                                <p class="text-sm font-semibold text-gray-700 mb-2">
                                    <i class="fas fa-info-circle mr-1"></i>Detalhamento:
                                </p>
                                <div class="grid grid-cols-2 gap-2 text-xs sm:text-sm text-gray-700">
                                    <div class="flex items-center">
                                        <i class="fas fa-calendar-alt text-gray-500 mr-2 w-4"></i>
                                        <span>Total: <strong>${data.totalDias} dias</strong></span>
                                    </div>
                                    <div class="flex items-center">
                                        <i class="fas fa-sun text-yellow-500 mr-2 w-4"></i>
                                        <span>Domingos: <strong>${data.domingos}</strong></span>
                                    </div>
                                    <div class="flex items-center">
                                        <i class="fas fa-calendar-week text-yellow-600 mr-2 w-4"></i>
                                        <span>Sábados: <strong>${data.sabados}</strong></span>
                                    </div>
                                    <div class="flex items-center">
                                        <i class="fas fa-calendar-times text-red-500 mr-2 w-4"></i>
                                        <span>Feriados: <strong>${data.feriados}</strong></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                            })
                            .catch(error => {
                                console.error('Erro:', error);
                                alert('Erro ao calcular dias úteis');
                            });
                    });

                    // Event Listeners para substituir inline handlers
                    document.addEventListener('DOMContentLoaded', function () {
                        // Cliques nos dias do calendário
                        var diasCalendario = document.querySelectorAll('.dia-calendario');
                        diasCalendario.forEach(function (dia) {
                            dia.addEventListener('click', function () {
                                var data = this.getAttribute('data-dia');
                                abrirModal(data);
                            });
                        });

                        // Botões de fechar modal
                        var btnFecharModal = document.getElementById('btnFecharModal');
                        if (btnFecharModal) {
                            btnFecharModal.addEventListener('click', fecharModal);
                        }

                        var btnFecharModalObrigacoes = document.getElementById('btnFecharModalObrigacoes');
                        if (btnFecharModalObrigacoes) {
                            btnFecharModalObrigacoes.addEventListener('click', fecharModal);
                        }

                        var btnCancelarAnotacao = document.getElementById('btnCancelarAnotacao');
                        if (btnCancelarAnotacao) {
                            btnCancelarAnotacao.addEventListener('click', fecharModal);
                        }

                        // Botões de abas
                        var tabAnotacao = document.getElementById('tab-anotacao');
                        if (tabAnotacao) {
                            tabAnotacao.addEventListener('click', function () {
                                mostrarAba('anotacao');
                            });
                        }

                        var tabObrigacoes = document.getElementById('tab-obrigacoes');
                        if (tabObrigacoes) {
                            tabObrigacoes.addEventListener('click', function () {
                                mostrarAba('obrigacoes');
                            });
                        }

                        // Botão salvar anotação
                        var btnSalvarAnotacao = document.getElementById('btnSalvarAnotacao');
                        if (btnSalvarAnotacao) {
                            btnSalvarAnotacao.addEventListener('click', salvarAnotacao);
                        }

                        // Botão adicionar obrigação
                        var btnAdicionarObrigacao = document.getElementById('btnAdicionarObrigacao');
                        if (btnAdicionarObrigacao) {
                            btnAdicionarObrigacao.addEventListener('click', adicionarObrigacao);
                        }

                        // Event delegation para botões de remover obrigação (criados dinamicamente)
                        document.addEventListener('click', function (e) {
                            if (e.target.closest('.btn-remover-obrigacao')) {
                                var btn = e.target.closest('.btn-remover-obrigacao');
                                var obrigacaoId = btn.getAttribute('data-obrigacao-id');
                                removerObrigacao(obrigacaoId);
                            }
                        });
                    });
                </script>
</body>

</html>