<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %></title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            red: '#DC2626',
                            yellow: '#FBBF24'
                        }
                    }
                }
            }
        }
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Favicon com as letras "DP" nas cores do sistema (Vermelho #DC2626 e Amarelo #FBBF24) -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 200 200'%3E%3Cdefs%3E%3ClinearGradient id='grad' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%23DC2626;stop-opacity:1' /%3E%3Cstop offset='100%25' style='stop-color:%23FBBF24;stop-opacity:1' /%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='200' height='200' rx='20' fill='url(%23grad)'/%3E%3Ctext x='100' y='140' font-family='Arial, sans-serif' font-size='120' font-weight='bold' text-anchor='middle' fill='white'%3EDP%3C/text%3E%3C/svg%3E" />
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 200 200'%3E%3Cdefs%3E%3ClinearGradient id='grad' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%23DC2626;stop-opacity:1' /%3E%3Cstop offset='100%25' style='stop-color:%23FBBF24;stop-opacity:1' /%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='200' height='200' rx='20' fill='url(%23grad)'/%3E%3Ctext x='100' y='140' font-family='Arial, sans-serif' font-size='120' font-weight='bold' text-anchor='middle' fill='white'%3EDP%3C/text%3E%3C/svg%3E" />
</head>
<body class="bg-gray-50">
    <%- include('../partials/navbar') %>

    <main class="max-w-7xl mx-auto px-2 sm:px-4 md:px-6 py-4 sm:py-8">
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-gray-900 mb-2">
                <i class="fas fa-bell text-primary-red mr-2"></i>
                Notifica√ß√µes Administrativas
            </h1>
            <p class="text-gray-600">
                Envie notifica√ß√µes para todos os usu√°rios ou para usu√°rios espec√≠ficos
            </p>
        </div>

        <!-- Formul√°rio de Nova Notifica√ß√£o -->
        <div class="bg-white rounded-lg shadow-md p-4 sm:p-6 mb-6 sm:mb-8">
            <h2 class="text-xl font-bold text-gray-900 mb-4">Nova Notifica√ß√£o</h2>
            <form id="formNotificacao" class="space-y-4">
                <div>
                    <label for="titulo" class="block text-sm font-medium text-gray-700 mb-2">
                        T√≠tulo <span class="text-red-500">*</span>
                    </label>
                    <input 
                        type="text" 
                        id="titulo" 
                        name="titulo" 
                        required
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-red focus:border-transparent"
                        placeholder="Ex: Lembrete: Fechamento de folha"
                    >
                </div>

                <div>
                    <label for="mensagem" class="block text-sm font-medium text-gray-700 mb-2">
                        Mensagem <span class="text-red-500">*</span>
                    </label>
                    <textarea 
                        id="mensagem" 
                        name="mensagem" 
                        required
                        rows="4"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-red focus:border-transparent"
                        placeholder="Digite a mensagem da notifica√ß√£o..."
                    ></textarea>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="tipo" class="block text-sm font-medium text-gray-700 mb-2">
                            Tipo <span class="text-red-500">*</span>
                        </label>
                        <select 
                            id="tipo" 
                            name="tipo" 
                            required
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-red focus:border-transparent"
                        >
                            <option value="info">‚ÑπÔ∏è Info</option>
                            <option value="warning">‚ö†Ô∏è Aviso</option>
                            <option value="success">‚úÖ Sucesso</option>
                            <option value="error">‚ùå Erro</option>
                        </select>
                    </div>

                    <div>
                        <label for="destinatario" class="block text-sm font-medium text-gray-700 mb-2">
                            Destinat√°rio <span class="text-red-500">*</span>
                        </label>
                        <div class="relative">
                            <input 
                                type="text" 
                                id="buscarDestinatario" 
                                placeholder="üîç Buscar usu√°rio por nome ou email..."
                                class="w-full px-3 sm:px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-red focus:border-transparent mb-2 text-sm sm:text-base"
                                autocomplete="off"
                            >
                            <select 
                                id="destinatario" 
                                name="destinatario" 
                                required
                                size="10"
                                class="w-full px-3 sm:px-4 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-red focus:border-primary-red text-sm sm:text-base bg-white"
                                style="min-height: 250px; max-height: 300px;"
                            >
                                <option value="todos">üì¢ Todos os usu√°rios</option>
                                <% 
                                // Debug: verifica o que est√° sendo recebido
                                let usuariosArray = [];
                                
                                // Verifica se usuarios existe e seu tipo
                                if (typeof usuarios !== 'undefined' && usuarios !== null) {
                                    if (Array.isArray(usuarios)) {
                                        usuariosArray = usuarios;
                                    }
                                }
                                
                                // Filtra usu√°rios n√£o-admin
                                const usuariosNaoAdmin = usuariosArray.filter(u => {
                                    if (!u || !u.id) return false;
                                    // Verifica se √© admin (pode ser boolean true ou string 'true')
                                    // No PostgreSQL, boolean pode vir como true/false ou 't'/'f'
                                    const isAdmin = u.is_admin === true || 
                                                   u.is_admin === 'true' || 
                                                   u.is_admin === 1 || 
                                                   u.is_admin === 't' ||
                                                   String(u.is_admin).toLowerCase() === 'true';
                                    return !isAdmin;
                                });
                                %>
                                <% if (usuariosArray.length > 0) { %>
                                    <% if (usuariosNaoAdmin.length > 0) { %>
                                        <% usuariosNaoAdmin.forEach(usuario => { %>
                                            <% if (usuario && usuario.id) { %>
                                                <option 
                                                    value="<%= usuario.id %>" 
                                                    data-nome="<%= (usuario.nome || '').toLowerCase() %>" 
                                                    data-email="<%= (usuario.email || '').toLowerCase() %>">
                                                    <%= usuario.nome || 'Sem nome' %> (<%= usuario.email || 'Sem email' %>)
                                                </option>
                                            <% } %>
                                        <% }); %>
                                    <% } else { %>
                                        <option value="" disabled>‚ö†Ô∏è Todos os usu√°rios cadastrados s√£o administradores</option>
                                    <% } %>
                                <% } else { %>
                                    <option value="" disabled>‚ùå Nenhum usu√°rio encontrado no sistema</option>
                                <% } %>
                            </select>
                            <p class="text-xs text-gray-500 mt-1" id="contadorUsuarios">
                                <% 
                                if (typeof usuarios !== 'undefined' && usuarios && Array.isArray(usuarios) && usuarios.length > 0) {
                                    const usuariosNaoAdmin = usuarios.filter(u => {
                                        if (!u || !u.id) return false;
                                        const isAdmin = u.is_admin === true || u.is_admin === 'true' || u.is_admin === 1;
                                        return !isAdmin;
                                    });
                                    if (usuariosNaoAdmin.length > 0) {
                                        %><%= usuariosNaoAdmin.length %> usu√°rio(s) dispon√≠vel(is)<%
                                    } else {
                                        %>‚ö†Ô∏è Todos os usu√°rios s√£o administradores<%
                                    }
                                } else {
                                    %>‚ùå Nenhum usu√°rio encontrado no sistema<%
                                }
                                %>
                            </p>
                        </div>
                    </div>
                </div>

                <div class="flex justify-end">
                    <button 
                        type="submit"
                        class="w-full sm:w-auto px-4 sm:px-6 py-2 bg-gradient-to-r from-primary-red to-primary-yellow text-white rounded-lg font-semibold hover:opacity-90 transition text-sm sm:text-base"
                    >
                        <i class="fas fa-paper-plane mr-2"></i>
                        Enviar Notifica√ß√£o
                    </button>
                </div>
            </form>
        </div>

        <!-- Hist√≥rico -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-bold text-gray-900 mb-4">Hist√≥rico de Notifica√ß√µes</h2>
            <% if (historico && historico.length > 0) { %>
                <div class="space-y-3">
                    <% historico.forEach(notif => { %>
                        <div class="border-l-4 p-4 rounded 
                            <%= notif.tipo === 'info' ? 'border-blue-500 bg-blue-50' :
                               notif.tipo === 'warning' ? 'border-yellow-500 bg-yellow-50' :
                               notif.tipo === 'success' ? 'border-green-500 bg-green-50' :
                               'border-red-500 bg-red-50' %>">
                            <div class="flex justify-between items-start">
                                <div class="flex-1">
                                    <h3 class="font-semibold text-gray-900"><%= notif.titulo %></h3>
                                    <p class="text-gray-700 mt-1"><%= notif.mensagem %></p>
                                    <div class="mt-2 text-sm text-gray-600">
                                        <i class="fas fa-user mr-1"></i>
                                        <%= notif.usuario_nome || 'Todos os usu√°rios' %>
                                        <span class="mx-2">‚Ä¢</span>
                                        <i class="fas fa-clock mr-1"></i>
                                        <%= new Date(notif.created_at).toLocaleString('pt-BR') %>
                                    </div>
                                </div>
                                <span class="px-2 py-1 rounded text-xs font-semibold
                                    <%= notif.tipo === 'info' ? 'bg-blue-200 text-blue-800' :
                                       notif.tipo === 'warning' ? 'bg-yellow-200 text-yellow-800' :
                                       notif.tipo === 'success' ? 'bg-green-200 text-green-800' :
                                       'bg-red-200 text-red-800' %>">
                                    <%= notif.tipo.toUpperCase() %>
                                </span>
                            </div>
                        </div>
                    <% }); %>
                </div>
            <% } else { %>
                <p class="text-gray-500 text-center py-8">Nenhuma notifica√ß√£o enviada ainda.</p>
            <% } %>
        </div>
    </main>

    <script>
        // Disponibiliza token CSRF globalmente
        window.csrfToken = '<%= typeof csrfToken !== "undefined" && csrfToken ? csrfToken : "" %>';
        
        function getCSRFHeaders() {
            const headers = { 'Content-Type': 'application/json' };
            if (window.csrfToken) {
                headers['X-CSRF-Token'] = window.csrfToken;
            }
            return headers;
        }

        // Fun√ß√£o para filtrar e destacar usu√°rios no select
        window.filtrarUsuarios = function(busca) {
            try {
                const select = document.getElementById('destinatario');
                if (!select) {
                    console.error('Select de destinat√°rio n√£o encontrado');
                    return;
                }

                const options = Array.from(select.querySelectorAll('option'));
                if (options.length === 0) {
                    console.warn('Nenhuma op√ß√£o encontrada no select');
                    return;
                }

                const buscaLower = (busca || '').toLowerCase().trim();
                let contador = 0;

                options.forEach(option => {
                    if (!option) return;

                    // Remove estilos anteriores
                    option.style.opacity = '';
                    option.style.fontWeight = '';
                    option.style.display = '';
                    option.style.visibility = '';
                    option.removeAttribute('hidden');
                    option.removeAttribute('disabled');
                    option.removeAttribute('data-hidden');

                    if (option.value === 'todos') {
                        // Op√ß√£o "Todos os usu√°rios" sempre vis√≠vel e contabilizada
                        if (buscaLower === '') contador++;
                    } else {
                        // Busca nos atributos e texto
                        const nome = (option.getAttribute('data-nome') || '').toLowerCase();
                        const email = (option.getAttribute('data-email') || '').toLowerCase();
                        const texto = option.textContent.toLowerCase();
                        
                        const corresponde = buscaLower === '' || 
                            nome.includes(buscaLower) || 
                            email.includes(buscaLower) ||
                            texto.includes(buscaLower);

                        if (corresponde) {
                            contador++;
                            // Destaca op√ß√µes que correspondem √† busca
                            if (buscaLower !== '') {
                                option.style.backgroundColor = '#fef3c7';
                                option.style.fontWeight = '600';
                            }
                        } else if (buscaLower !== '') {
                            // Para op√ß√µes que n√£o correspondem, apenas reduz opacidade
                            // MAS MANT√âM SELECION√ÅVEL
                            option.style.opacity = '0.4';
                        }
                    }
                });

                // Atualiza contador
                const contadorEl = document.getElementById('contadorUsuarios');
                if (contadorEl) {
                    if (buscaLower === '') {
                        const total = options.filter(o => o.value !== 'todos').length;
                        contadorEl.textContent = `${total} usu√°rio(s) dispon√≠vel(is)`;
                    } else {
                        contadorEl.textContent = `${contador} usu√°rio(s) encontrado(s)`;
                    }
                }
            } catch (error) {
                console.error('Erro ao filtrar usu√°rios:', error);
            }
        };

        // Limpa filtro ao selecionar
        document.addEventListener('DOMContentLoaded', () => {
            const select = document.getElementById('destinatario');
            const buscarInput = document.getElementById('buscarDestinatario');
            
            console.log('üîç [CLIENTE] Verificando elementos de destinat√°rio...');
            console.log('üîç [CLIENTE] Select encontrado:', !!select);
            console.log('üîç [CLIENTE] Input encontrado:', !!buscarInput);
            
            if (!select) {
                console.error('‚ùå [CLIENTE] Select de destinat√°rio n√£o encontrado no DOMContentLoaded');
                return;
            }

            if (!buscarInput) {
                console.error('‚ùå [CLIENTE] Input de busca n√£o encontrado');
                return;
            }

            // Verifica quantas op√ß√µes existem no select
            const options = Array.from(select.querySelectorAll('option'));
            console.log('üìã [CLIENTE] Total de op√ß√µes no select:', options.length);
            
            if (options.length === 0) {
                console.error('‚ùå [CLIENTE] Nenhuma op√ß√£o encontrada no select!');
            } else {
                console.log('‚úÖ [CLIENTE] Op√ß√µes encontradas:');
                options.forEach((opt, index) => {
                    if (index < 10) { // Mostra at√© 10 op√ß√µes
                        console.log(`  ${index + 1}. value="${opt.value}" - text="${opt.textContent.substring(0, 50)}" - disabled=${opt.disabled}`);
                    }
                });
                
                // Verifica se h√° op√ß√µes al√©m de "todos"
                const opcoesUsuarios = options.filter(opt => opt.value !== 'todos' && !opt.disabled && opt.value !== '');
                console.log('üë• [CLIENTE] Op√ß√µes de usu√°rios dispon√≠veis (n√£o "todos" e n√£o disabled):', opcoesUsuarios.length);
                
                if (opcoesUsuarios.length === 0) {
                    console.warn('‚ö†Ô∏è [CLIENTE] Nenhum usu√°rio dispon√≠vel para sele√ß√£o!');
                    console.warn('   Verifique se h√° usu√°rios n√£o-admin no banco de dados.');
                    console.warn('   Verifique os logs do servidor para ver quantos usu√°rios foram encontrados.');
                } else {
                    console.log('‚úÖ [CLIENTE] Usu√°rios dispon√≠veis para sele√ß√£o:');
                    opcoesUsuarios.forEach((opt, index) => {
                        if (index < 5) {
                            console.log(`  ${index + 1}. ${opt.textContent}`);
                        }
                    });
                }
            }

            // Event listener para mudan√ßa no select - permite sele√ß√£o normal
            select.addEventListener('change', (e) => {
                const valorSelecionado = e.target.value;
                console.log('‚úÖ Usu√°rio selecionado:', valorSelecionado);
                
                // Valida se a sele√ß√£o foi bem-sucedida
                if (valorSelecionado && valorSelecionado !== '') {
                    const opcaoSelecionada = Array.from(select.options).find(opt => opt.value === valorSelecionado);
                    if (opcaoSelecionada) {
                        console.log('‚úÖ Op√ß√£o encontrada:', opcaoSelecionada.textContent);
                    }
                }
            });

            // Event listener para clique - garante que funciona
            select.addEventListener('click', (e) => {
                console.log('üñ±Ô∏è Select clicado');
                e.stopPropagation();
            });

            // Event listener para foco - garante que est√° ativo
            select.addEventListener('focus', () => {
                console.log('üëÅÔ∏è Select recebeu foco');
            });

            // Event listener para input de busca (al√©m do onkeyup inline)
            buscarInput.addEventListener('input', (e) => {
                window.filtrarUsuarios(e.target.value);
            });

            // Event listener para tecla Enter (evita submit e foca no select)
            buscarInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    // Foca no select ap√≥s Enter para facilitar sele√ß√£o
                    setTimeout(() => select.focus(), 100);
                }
            });

            // Garante que o select √© totalmente interativo
            select.style.pointerEvents = 'auto';
            select.style.cursor = 'pointer';
            select.style.userSelect = 'auto';

            // Remove qualquer overlay que possa estar bloqueando
            const parentDiv = select.closest('.relative');
            if (parentDiv) {
                parentDiv.style.pointerEvents = 'auto';
            }

            // Inicializa contador
            window.filtrarUsuarios('');
            
            // Debug: verifica dados recebidos do servidor (se dispon√≠vel via script tag)
            console.log('üîç [CLIENTE] Verificando dados do servidor...');
            const selectOptions = Array.from(select.querySelectorAll('option'));
            console.log('üîç [CLIENTE] Total de op√ß√µes renderizadas:', selectOptions.length);
            if (selectOptions.length <= 2) {
                console.error('‚ùå [CLIENTE] PROBLEMA: Apenas', selectOptions.length, 'op√ß√µes foram renderizadas!');
                console.error('   Isso indica que a vari√°vel "usuarios" n√£o est√° sendo passada corretamente do servidor.');
                console.error('   Verifique os logs do servidor para ver quantos usu√°rios foram encontrados.');
            }
        });

        document.getElementById('formNotificacao').addEventListener('submit', async (e) => {
            e.preventDefault();

            const formData = new FormData(e.target);
            const data = {
                titulo: formData.get('titulo'),
                mensagem: formData.get('mensagem'),
                tipo: formData.get('tipo'),
                destinatario: formData.get('destinatario')
            };

            // Adiciona CSRF token
            if (window.csrfToken) {
                data._csrf = window.csrfToken;
            }

            try {
                const headers = getCSRFHeaders();
                
                const response = await fetch('/admin/notificacoes/criar', {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(data),
                    credentials: 'same-origin'
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Erro ${response.status}: ${errorText}`);
                }

                const result = await response.json();

                if (result.success) {
                    alert('‚úÖ ' + result.message);
                    e.target.reset();
                    location.reload();
                } else {
                    alert('‚ùå Erro: ' + (result.error || 'Erro ao criar notifica√ß√£o'));
                }
            } catch (error) {
                console.error('Erro ao criar notifica√ß√£o:', error);
                alert('‚ùå Erro ao criar notifica√ß√£o: ' + error.message);
            }
        });
    </script>
</body>
</html>

