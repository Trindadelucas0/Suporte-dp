<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %></title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            red: '#DC2626',
                            yellow: '#FBBF24'
                        }
                    }
                }
            }
        }
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gray-50">
    <%- include('../partials/navbar') %>

    <main class="max-w-7xl mx-auto px-2 sm:px-4 md:px-6 py-4 sm:py-8">
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-gray-900 mb-2">
                <i class="fas fa-bell text-primary-red mr-2"></i>
                Notifica√ß√µes Administrativas
            </h1>
            <p class="text-gray-600">
                Envie notifica√ß√µes para todos os usu√°rios ou para usu√°rios espec√≠ficos
            </p>
        </div>

        <!-- Formul√°rio de Nova Notifica√ß√£o -->
        <div class="bg-white rounded-lg shadow-md p-4 sm:p-6 mb-6 sm:mb-8">
            <h2 class="text-xl font-bold text-gray-900 mb-4">Nova Notifica√ß√£o</h2>
            <form id="formNotificacao" class="space-y-4">
                <div>
                    <label for="titulo" class="block text-sm font-medium text-gray-700 mb-2">
                        T√≠tulo <span class="text-red-500">*</span>
                    </label>
                    <input 
                        type="text" 
                        id="titulo" 
                        name="titulo" 
                        required
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-red focus:border-transparent"
                        placeholder="Ex: Lembrete: Fechamento de folha"
                    >
                </div>

                <div>
                    <label for="mensagem" class="block text-sm font-medium text-gray-700 mb-2">
                        Mensagem <span class="text-red-500">*</span>
                    </label>
                    <textarea 
                        id="mensagem" 
                        name="mensagem" 
                        required
                        rows="4"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-red focus:border-transparent"
                        placeholder="Digite a mensagem da notifica√ß√£o..."
                    ></textarea>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="tipo" class="block text-sm font-medium text-gray-700 mb-2">
                            Tipo <span class="text-red-500">*</span>
                        </label>
                        <select 
                            id="tipo" 
                            name="tipo" 
                            required
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-red focus:border-transparent"
                        >
                            <option value="info">‚ÑπÔ∏è Info</option>
                            <option value="warning">‚ö†Ô∏è Aviso</option>
                            <option value="success">‚úÖ Sucesso</option>
                            <option value="error">‚ùå Erro</option>
                        </select>
                    </div>

                    <div>
                        <label for="destinatario" class="block text-sm font-medium text-gray-700 mb-2">
                            Destinat√°rio <span class="text-red-500">*</span>
                        </label>
                        <div class="relative">
                            <input 
                                type="text" 
                                id="buscarDestinatario" 
                                placeholder="üîç Buscar usu√°rio por nome ou email..."
                                class="w-full px-3 sm:px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-red focus:border-transparent mb-2 text-sm sm:text-base"
                                onkeyup="filtrarUsuarios(this.value)"
                            >
                            <select 
                                id="destinatario" 
                                name="destinatario" 
                                required
                                size="6"
                                class="w-full px-3 sm:px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-red focus:border-transparent overflow-y-auto text-sm sm:text-base"
                            >
                                <option value="todos">üì¢ Todos os usu√°rios</option>
                                <% if (usuarios && usuarios.length > 0) { %>
                                    <% usuarios.forEach(usuario => { %>
                                        <% if (!usuario.is_admin) { %>
                                            <option value="<%= usuario.id %>" data-nome="<%= usuario.nome.toLowerCase() %>" data-email="<%= usuario.email.toLowerCase() %>">
                                                <%= usuario.nome %> (<%= usuario.email %>)
                                            </option>
                                        <% } %>
                                    <% }); %>
                                <% } %>
                            </select>
                            <p class="text-xs text-gray-500 mt-1" id="contadorUsuarios">
                                <% if (usuarios && usuarios.length > 0) { %>
                                    <%= usuarios.filter(u => !u.is_admin).length %> usu√°rio(s) dispon√≠vel(is)
                                <% } else { %>
                                    Nenhum usu√°rio dispon√≠vel
                                <% } %>
                            </p>
                        </div>
                    </div>
                </div>

                <div class="flex justify-end">
                    <button 
                        type="submit"
                        class="w-full sm:w-auto px-4 sm:px-6 py-2 bg-gradient-to-r from-primary-red to-primary-yellow text-white rounded-lg font-semibold hover:opacity-90 transition text-sm sm:text-base"
                    >
                        <i class="fas fa-paper-plane mr-2"></i>
                        Enviar Notifica√ß√£o
                    </button>
                </div>
            </form>
        </div>

        <!-- Hist√≥rico -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-bold text-gray-900 mb-4">Hist√≥rico de Notifica√ß√µes</h2>
            <% if (historico && historico.length > 0) { %>
                <div class="space-y-3">
                    <% historico.forEach(notif => { %>
                        <div class="border-l-4 p-4 rounded 
                            <%= notif.tipo === 'info' ? 'border-blue-500 bg-blue-50' :
                               notif.tipo === 'warning' ? 'border-yellow-500 bg-yellow-50' :
                               notif.tipo === 'success' ? 'border-green-500 bg-green-50' :
                               'border-red-500 bg-red-50' %>">
                            <div class="flex justify-between items-start">
                                <div class="flex-1">
                                    <h3 class="font-semibold text-gray-900"><%= notif.titulo %></h3>
                                    <p class="text-gray-700 mt-1"><%= notif.mensagem %></p>
                                    <div class="mt-2 text-sm text-gray-600">
                                        <i class="fas fa-user mr-1"></i>
                                        <%= notif.usuario_nome || 'Todos os usu√°rios' %>
                                        <span class="mx-2">‚Ä¢</span>
                                        <i class="fas fa-clock mr-1"></i>
                                        <%= new Date(notif.created_at).toLocaleString('pt-BR') %>
                                    </div>
                                </div>
                                <span class="px-2 py-1 rounded text-xs font-semibold
                                    <%= notif.tipo === 'info' ? 'bg-blue-200 text-blue-800' :
                                       notif.tipo === 'warning' ? 'bg-yellow-200 text-yellow-800' :
                                       notif.tipo === 'success' ? 'bg-green-200 text-green-800' :
                                       'bg-red-200 text-red-800' %>">
                                    <%= notif.tipo.toUpperCase() %>
                                </span>
                            </div>
                        </div>
                    <% }); %>
                </div>
            <% } else { %>
                <p class="text-gray-500 text-center py-8">Nenhuma notifica√ß√£o enviada ainda.</p>
            <% } %>
        </div>
    </main>

    <script>
        // Disponibiliza token CSRF globalmente
        window.csrfToken = '<%= typeof csrfToken !== "undefined" && csrfToken ? csrfToken : "" %>';
        
        function getCSRFHeaders() {
            const headers = { 'Content-Type': 'application/json' };
            if (window.csrfToken) {
                headers['X-CSRF-Token'] = window.csrfToken;
            }
            return headers;
        }

        // Fun√ß√£o para filtrar usu√°rios no select
        function filtrarUsuarios(busca) {
            const select = document.getElementById('destinatario');
            const options = select.querySelectorAll('option');
            const buscaLower = busca.toLowerCase().trim();
            let contador = 0;

            options.forEach(option => {
                if (option.value === 'todos') {
                    option.style.display = buscaLower === '' ? 'block' : 'none';
                    if (buscaLower === '') contador++;
                } else {
                    const nome = option.getAttribute('data-nome') || '';
                    const email = option.getAttribute('data-email') || '';
                    
                    if (buscaLower === '' || nome.includes(buscaLower) || email.includes(buscaLower)) {
                        option.style.display = 'block';
                        contador++;
                    } else {
                        option.style.display = 'none';
                    }
                }
            });

            // Atualiza contador
            const contadorEl = document.getElementById('contadorUsuarios');
            if (contadorEl) {
                contadorEl.textContent = `${contador} usu√°rio(s) encontrado(s)`;
            }
        }

        // Limpa filtro ao selecionar
        document.addEventListener('DOMContentLoaded', () => {
            const select = document.getElementById('destinatario');
            const buscarInput = document.getElementById('buscarDestinatario');
            
            if (select) {
                select.addEventListener('change', () => {
                    if (buscarInput) {
                        buscarInput.value = '';
                        filtrarUsuarios('');
                    }
                });
            }
        });

        document.getElementById('formNotificacao').addEventListener('submit', async (e) => {
            e.preventDefault();

            const formData = new FormData(e.target);
            const data = {
                titulo: formData.get('titulo'),
                mensagem: formData.get('mensagem'),
                tipo: formData.get('tipo'),
                destinatario: formData.get('destinatario')
            };

            // Adiciona CSRF token
            if (window.csrfToken) {
                data._csrf = window.csrfToken;
            }

            try {
                const headers = getCSRFHeaders();
                
                const response = await fetch('/admin/notificacoes/criar', {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(data),
                    credentials: 'same-origin'
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Erro ${response.status}: ${errorText}`);
                }

                const result = await response.json();

                if (result.success) {
                    alert('‚úÖ ' + result.message);
                    e.target.reset();
                    location.reload();
                } else {
                    alert('‚ùå Erro: ' + (result.error || 'Erro ao criar notifica√ß√£o'));
                }
            } catch (error) {
                console.error('Erro ao criar notifica√ß√£o:', error);
                alert('‚ùå Erro ao criar notifica√ß√£o: ' + error.message);
            }
        });
    </script>
</body>
</html>

