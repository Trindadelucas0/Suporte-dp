<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>
        <%= title %>
    </title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: { red: '#DC2626', yellow: '#FBBF24' }
                    }
                }
            }
        }
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body class="bg-gray-50">
    <% if (typeof user !=='undefined' && user) { %>
        <%- include('../partials/navbar') %>
            <% } %>

                <main class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
                    <div class="mb-6 flex justify-between items-center">
                        <div>
                            <h1 class="text-3xl font-bold text-gray-900">Gestão de Usuários</h1>
                            <p class="mt-2 text-gray-600">Visualize e gerencie todos os usuários do sistema</p>
                        </div>
                        <a href="/admin" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">
                            <i class="fas fa-arrow-left mr-2"></i>Voltar
                        </a>
                    </div>

                    <% if (typeof error !=='undefined' && error) { %>
                        <div class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded mb-6">
                            <strong>Erro:</strong>
                            <%= error %>
                        </div>
                        <% } %>

                            <!-- Filtros -->
                            <div class="bg-white rounded-lg shadow-md p-4 mb-6">
                                <div class="flex flex-wrap gap-4">
                                    <% const filtroAtivoParam=typeof filtroAtivo !=='undefined' ? filtroAtivo : null; %>
                                        <% const filtroBloqueadoParam=typeof filtroBloqueado !=='undefined' ?
                                            filtroBloqueado : null; %>
                                            <a href="/admin/usuarios"
                                                class="px-4 py-2 rounded <%= !filtroAtivoParam && !filtroBloqueadoParam ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300' %>">
                                                Todos
                                            </a>
                                            <a href="/admin/usuarios?ativo=true"
                                                class="px-4 py-2 rounded <%= filtroAtivoParam === 'true' ? 'bg-green-500 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300' %>">
                                                Ativos
                                            </a>
                                            <a href="/admin/usuarios?ativo=false"
                                                class="px-4 py-2 rounded <%= filtroAtivoParam === 'false' ? 'bg-red-500 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300' %>">
                                                Inativos
                                            </a>
                                            <a href="/admin/usuarios?bloqueado=true"
                                                class="px-4 py-2 rounded <%= filtroBloqueadoParam === 'true' ? 'bg-red-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300' %>">
                                                Bloqueados
                                            </a>
                                </div>
                            </div>

                            <!-- Tabela de Usuários -->
                            <div class="bg-white rounded-lg shadow-md overflow-hidden">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th
                                                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                Usuário</th>
                                            <th
                                                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                Email</th>
                                            <th
                                                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                Status</th>
                                            <th
                                                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                Cadastro</th>
                                            <th
                                                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                Último Login</th>
                                            <th
                                                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                Ações</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white divide-y divide-gray-200">
                                        <% if (usuarios && usuarios.length> 0) { %>
                                            <% usuarios.forEach(usuario=> { %>
                                                <tr class="hover:bg-gray-50">
                                                    <td class="px-6 py-4 whitespace-nowrap">
                                                        <div class="flex items-center">
                                                            <div
                                                                class="flex-shrink-0 h-10 w-10 rounded-full bg-gradient-to-r from-primary-red to-primary-yellow flex items-center justify-center text-white font-bold">
                                                                <%= usuario.nome.charAt(0).toUpperCase() %>
                                                            </div>
                                                            <div class="ml-4">
                                                                <div class="text-sm font-medium text-gray-900">
                                                                    <%= usuario.nome %>
                                                                        <% if (usuario.is_admin) { %>
                                                                            <span
                                                                                class="ml-2 px-2 py-1 text-xs bg-purple-100 text-purple-800 rounded">Admin</span>
                                                                            <% } %>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </td>
                                                    <td class="px-6 py-4 whitespace-nowrap">
                                                        <div class="text-sm text-gray-900">
                                                            <%= usuario.email %>
                                                        </div>
                                                    </td>
                                                    <td class="px-6 py-4 whitespace-nowrap">
                                                        <% const isBloqueado=usuario.bloqueado===true ||
                                                            usuario.bloqueado==='true' ; const isAtivo=usuario.ativo
                                                            !==false && usuario.ativo !=='false' && usuario.ativo
                                                            !==null && usuario.ativo !==undefined; %>
                                                            <% if (isBloqueado) { %>
                                                                <span
                                                                    class="px-2 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-800">Bloqueado</span>
                                                                <% } else if (!isAtivo) { %>
                                                                    <span
                                                                        class="px-2 py-1 text-xs font-semibold rounded-full bg-gray-100 text-gray-800">Inativo</span>
                                                                    <% } else { %>
                                                                        <span
                                                                            class="px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">Ativo</span>
                                                                        <% } %>
                                                    </td>
                                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                                        <%= usuario.created_at ? new
                                                            Date(usuario.created_at).toLocaleDateString('pt-BR') : 'N/A'
                                                            %>
                                                    </td>
                                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                                        <%= usuario.last_login ? new
                                                            Date(usuario.last_login).toLocaleDateString('pt-BR') + ' ' +
                                                            new Date(usuario.last_login).toLocaleTimeString('pt-BR')
                                                            : 'Nunca' %>
                                                    </td>
                                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                                        <div class="flex space-x-2">
                                                            <a href="/admin/usuarios/<%= usuario.id %>"
                                                                class="text-blue-600 hover:text-blue-900"
                                                                title="Ver detalhes">
                                                                <i class="fas fa-eye"></i>
                                                            </a>
                                                            <% const usuarioAtivo=usuario.ativo !==false &&
                                                                usuario.ativo !=='false' && usuario.ativo !==null &&
                                                                usuario.ativo !==undefined; const
                                                                usuarioBloqueado=usuario.bloqueado===true ||
                                                                usuario.bloqueado==='true' ; const
                                                                ativoClass=usuarioAtivo
                                                                ? 'text-gray-600 hover:text-gray-900'
                                                                : 'text-green-600 hover:text-green-900' ; const
                                                                bloqueadoClass=usuarioBloqueado
                                                                ? 'text-green-600 hover:text-green-900'
                                                                : 'text-red-600 hover:text-red-900' ; const
                                                                novoValorAtivo=usuarioAtivo ? 'false' : 'true' ; const
                                                                novoValorBloqueado=usuarioBloqueado ? 'false' : 'true' ;
                                                                %>
                                                                <button
                                                                    onclick="toggleStatus('<%= usuario.id %>', 'ativo', '<%= novoValorAtivo %>')"
                                                                    class="<%= ativoClass %>"
                                                                    title="<%= usuarioAtivo ? 'Desativar' : 'Ativar' %>">
                                                                    <i
                                                                        class="fas fa-<%= usuarioAtivo ? 'ban' : 'check' %>"></i>
                                                                </button>
                                                                <button
                                                                    onclick="toggleStatus('<%= usuario.id %>', 'bloqueado', '<%= novoValorBloqueado %>')"
                                                                    class="<%= bloqueadoClass %>"
                                                                    title="<%= usuarioBloqueado ? 'Desbloquear' : 'Bloquear' %>">
                                                                    <i
                                                                        class="fas fa-<%= usuarioBloqueado ? 'unlock' : 'lock' %>"></i>
                                                                </button>
                                                                <button
                                                                    onclick="resetarSenha('<%= usuario.id %>', '<%= usuario.nome %>')"
                                                                    class="text-yellow-600 hover:text-yellow-900"
                                                                    title="Resetar senha">
                                                                    <i class="fas fa-key"></i>
                                                                </button>
                                                        </div>
                                                    </td>
                                                </tr>
                                                <% }); %>
                                                    <% } else { %>
                                                        <tr>
                                                            <td colspan="6" class="px-6 py-4 text-center text-gray-500">
                                                                Nenhum usuário encontrado
                                                            </td>
                                                        </tr>
                                                        <% } %>
                                    </tbody>
                                </table>
                            </div>

                            <script>
                                async function toggleStatus(userId, campo, valor) {
                                    // Converte string para boolean se necessário
                                    const valorBool = valor === 'true' || valor === true;
                                    const acao = valorBool ? (campo === 'bloqueado' ? 'bloquear' : 'ativar') : (campo === 'bloqueado' ? 'desbloquear' : 'desativar');
                                    if (!confirm('Tem certeza que deseja ' + acao + ' este usuário?')) {
                                        return;
                                    }

                                    try {
                                        const response = await fetch('/admin/usuarios/' + userId + '/atualizar', {
                                            method: 'POST',
                                            headers: {
                                                'Content-Type': 'application/json'
                                            },
                                            body: JSON.stringify({ [campo]: valorBool })
                                        });

                                        const data = await response.json();
                                        if (data.success) {
                                            location.reload();
                                        } else {
                                            alert('Erro: ' + (data.error || 'Erro ao atualizar usuário'));
                                        }
                                    } catch (error) {
                                        alert('Erro ao atualizar usuário');
                                        console.error(error);
                                    }
                                }

                                function resetarSenha(userId, nome) {
                                    const novaSenha = prompt('Digite a nova senha para ' + nome + ':');
                                    if (!novaSenha || novaSenha.length < 6) {
                                        alert('Senha deve ter pelo menos 6 caracteres');
                                        return;
                                    }

                                    if (!confirm('Tem certeza que deseja alterar a senha de ' + nome + '?')) {
                                        return;
                                    }

                                    fetch('/admin/usuarios/' + userId + '/resetar-senha', {
                                        method: 'POST',
                                        headers: {
                                            'Content-Type': 'application/json'
                                        },
                                        body: JSON.stringify({ novaSenha: novaSenha })
                                    })
                                        .then(res => res.json())
                                        .then(data => {
                                            if (data.success) {
                                                alert('Senha alterada com sucesso!');
                                            } else {
                                                alert('Erro: ' + (data.error || 'Erro ao alterar senha'));
                                            }
                                        })
                                        .catch(error => {
                                            alert('Erro ao alterar senha');
                                            console.error(error);
                                        });
                                }
                            </script>
                </main>
</body>

</html>