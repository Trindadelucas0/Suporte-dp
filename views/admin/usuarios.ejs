<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>
        <%= title %>
    </title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: { red: '#DC2626', yellow: '#FBBF24' }
                    }
                }
            }
        }
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body class="bg-gray-50">
    <% if (typeof user !=='undefined' && user) { %>
        <%- include('../partials/navbar') %>
            <% } %>

                <main class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
                    <div class="mb-6 flex justify-between items-center">
                        <div>
                            <h1 class="text-3xl font-bold text-gray-900">Gestão de Usuários</h1>
                            <p class="mt-2 text-gray-600">Visualize e gerencie todos os usuários do sistema</p>
                        </div>
                        <a href="/admin" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">
                            <i class="fas fa-arrow-left mr-2"></i>Voltar
                        </a>
                    </div>

                    <% if (typeof error !=='undefined' && error) { %>
                        <div class="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded mb-6">
                            <strong>Erro:</strong>
                            <%= error %>
                        </div>
                        <% } %>

                            <!-- Filtros -->
                            <div class="bg-white rounded-lg shadow-md p-4 mb-6">
                                <div class="flex flex-wrap gap-4">
                                    <% const filtroAtivoParam=typeof filtroAtivo !=='undefined' ? filtroAtivo : null; %>
                                        <% const filtroBloqueadoParam=typeof filtroBloqueado !=='undefined' ?
                                            filtroBloqueado : null; %>
                                            <a href="/admin/usuarios"
                                                class="px-4 py-2 rounded <%= !filtroAtivoParam && !filtroBloqueadoParam ? 'bg-blue-500 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300' %>">
                                                Todos
                                            </a>
                                            <a href="/admin/usuarios?ativo=true"
                                                class="px-4 py-2 rounded <%= filtroAtivoParam === 'true' ? 'bg-green-500 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300' %>">
                                                Ativos
                                            </a>
                                            <a href="/admin/usuarios?ativo=false"
                                                class="px-4 py-2 rounded <%= filtroAtivoParam === 'false' ? 'bg-red-500 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300' %>">
                                                Inativos
                                            </a>
                                            <a href="/admin/usuarios?bloqueado=true"
                                                class="px-4 py-2 rounded <%= filtroBloqueadoParam === 'true' ? 'bg-red-600 text-white' : 'bg-gray-200 text-gray-700 hover:bg-gray-300' %>">
                                                Bloqueados
                                            </a>
                                </div>
                            </div>

                            <!-- Tabela de Usuários -->
                            <div class="bg-white rounded-lg shadow-md overflow-hidden">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th
                                                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                Usuário</th>
                                            <th
                                                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                Email / WhatsApp</th>
                                            <th
                                                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                Status</th>
                                            <th
                                                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                Pagamento</th>
                                            <th
                                                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                Assinatura</th>
                                            <th
                                                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                Último Pagamento</th>
                                            <th
                                                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                Último Login</th>
                                            <th
                                                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                Ações</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white divide-y divide-gray-200">
                                        <% if (usuarios && usuarios.length> 0) { %>
                                            <% usuarios.forEach(usuario=> { %>
                                                <tr class="hover:bg-gray-50">
                                                    <td class="px-6 py-4 whitespace-nowrap">
                                                        <div class="flex items-center">
                                                            <div
                                                                class="flex-shrink-0 h-10 w-10 rounded-full bg-gradient-to-r from-primary-red to-primary-yellow flex items-center justify-center text-white font-bold">
                                                                <%= usuario.nome.charAt(0).toUpperCase() %>
                                                            </div>
                                                            <div class="ml-4">
                                                                <div class="text-sm font-medium text-gray-900">
                                                                    <%= usuario.nome %>
                                                                        <% if (usuario.is_admin) { %>
                                                                            <span
                                                                                class="ml-2 px-2 py-1 text-xs bg-purple-100 text-purple-800 rounded">Admin</span>
                                                                            <% } %>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </td>
                                                    <td class="px-6 py-4 whitespace-nowrap">
                                                        <div class="text-sm text-gray-900">
                                                            <%= usuario.email %>
                                                        </div>
                                                        <% if (usuario.whatsapp) { %>
                                                            <div class="text-xs text-gray-500">
                                                                <i class="fas fa-phone mr-1"></i>
                                                                <%= usuario.whatsapp %>
                                                            </div>
                                                            <% } %>
                                                    </td>
                                                    <td class="px-6 py-4 whitespace-nowrap">
                                                        <% const isBloqueado=usuario.status==='bloqueado' ||
                                                            usuario.bloqueado===true; %>
                                                            <% const isAtivo=usuario.status==='ativo' ; %>
                                                                <% if (isBloqueado) { %>
                                                                    <span
                                                                        class="px-2 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-800">Bloqueado</span>
                                                                    <% } else if (!isAtivo) { %>
                                                                        <span
                                                                            class="px-2 py-1 text-xs font-semibold rounded-full bg-gray-100 text-gray-800">Inativo</span>
                                                                        <% } else { %>
                                                                            <span
                                                                                class="px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">Ativo</span>
                                                                            <% } %>
                                                    </td>
                                                    <!-- COLUNA: STATUS DE PAGAMENTO -->
                                                    <td class="px-6 py-4 whitespace-nowrap">
                                                        <% if (usuario.is_admin) { %>
                                                            <span class="px-2 py-1 text-xs font-semibold rounded-full bg-purple-100 text-purple-800">
                                                                <i class="fas fa-user-shield mr-1"></i>Admin
                                                            </span>
                                                        <% } else if (usuario.temPagamentoAtivo) { %>
                                                            <span class="px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">
                                                                <i class="fas fa-check-circle mr-1"></i>Pago
                                                            </span>
                                                            <% if (typeof usuario.diasRestantes==='number') { %>
                                                                <div class="text-xs text-gray-600 mt-1 font-medium">
                                                                    <%= usuario.diasRestantes %> dia<%= usuario.diasRestantes !== 1 ? 's' : '' %> restante<%= usuario.diasRestantes !== 1 ? 's' : '' %>
                                                                </div>
                                                            <% } %>
                                                        <% } else if (usuario.ultimoPagamento && usuario.estaExpirado) { %>
                                                            <span class="px-2 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-800">
                                                                <i class="fas fa-times-circle mr-1"></i>Expirado
                                                            </span>
                                                            <% if (typeof usuario.diasRestantes==='number') { %>
                                                                <div class="text-xs text-red-600 mt-1 font-medium">
                                                                    <%= Math.abs(usuario.diasRestantes) %> dia<%= Math.abs(usuario.diasRestantes) !== 1 ? 's' : '' %> atrás
                                                                </div>
                                                            <% } %>
                                                        <% } else if (usuario.ultimoPagamento && !usuario.temPagamentoAtivo && typeof usuario.diasRestantes==='number' && usuario.diasRestantes <= 7) { %>
                                                            <span class="px-2 py-1 text-xs font-semibold rounded-full bg-yellow-100 text-yellow-800">
                                                                <i class="fas fa-exclamation-triangle mr-1"></i>Vencendo
                                                            </span>
                                                            <div class="text-xs text-yellow-600 mt-1 font-medium">
                                                                <%= usuario.diasRestantes %> dia<%= usuario.diasRestantes !== 1 ? 's' : '' %> restante<%= usuario.diasRestantes !== 1 ? 's' : '' %>
                                                            </div>
                                                        <% } else { %>
                                                            <span class="px-2 py-1 text-xs font-semibold rounded-full bg-gray-100 text-gray-800">
                                                                <i class="fas fa-times mr-1"></i>Não Pago
                                                            </span>
                                                            <div class="text-xs text-gray-400 mt-1">Sem pagamento</div>
                                                        <% } %>
                                                    </td>
                                                    <!-- COLUNA: ASSINATURA -->
                                                    <td class="px-6 py-4 whitespace-nowrap">
                                                        <% const subscriptionStatus=usuario.subscription_status || 'N/A'; %>
                                                        <% if (subscriptionStatus==='ativa') { %>
                                                            <span class="px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">Ativa</span>
                                                        <% } else if (subscriptionStatus==='inadimplente') { %>
                                                            <span class="px-2 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-800">Inadimplente</span>
                                                        <% } else { %>
                                                            <span class="px-2 py-1 text-xs font-semibold rounded-full bg-gray-100 text-gray-800">
                                                                <%= subscriptionStatus %>
                                                            </span>
                                                        <% } %>
                                                        <% if (usuario.subscription_expires_at) { %>
                                                            <div class="text-xs text-gray-500 mt-1">
                                                                Expira: <%= new Date(usuario.subscription_expires_at).toLocaleDateString('pt-BR') %>
                                                            </div>
                                                        <% } %>
                                                        <% if (typeof usuario.totalPagamentos === 'number' && usuario.totalPagamentos > 0) { %>
                                                            <div class="text-xs text-gray-400 mt-1">
                                                                <%= usuario.totalPagamentos %> pagamento<%= usuario.totalPagamentos !== 1 ? 's' : '' %> no total
                                                            </div>
                                                        <% } %>
                                                    </td>
                                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                                        <% if (usuario.ultimoPagamento) { %>
                                                            <div class="font-semibold text-green-600">
                                                                <i class="fas fa-money-bill-wave mr-1"></i>
                                                                R$ <%= parseFloat(usuario.ultimoPagamento.paid_amount || 0).toFixed(2).replace('.', ',') %>
                                                            </div>
                                                            <div class="text-xs text-gray-500 mt-1">
                                                                <i class="fas fa-calendar mr-1"></i>
                                                                <%= new Date(usuario.ultimoPagamento.paid_at).toLocaleDateString('pt-BR') %>
                                                            </div>
                                                            <div class="text-xs text-gray-400 mt-1">
                                                                Método: <%= usuario.ultimoPagamento.capture_method || 'N/A' %>
                                                            </div>
                                                            <% if (usuario.ultimoPagamento.status==='paid') { %>
                                                                <span class="inline-block mt-1 px-2 py-0.5 text-xs font-semibold rounded-full bg-green-100 text-green-800">
                                                                    <i class="fas fa-check mr-1"></i>Confirmado
                                                                </span>
                                                            <% } else { %>
                                                                <span class="inline-block mt-1 px-2 py-0.5 text-xs font-semibold rounded-full bg-yellow-100 text-yellow-800">
                                                                    <%= usuario.ultimoPagamento.status || 'Pendente' %>
                                                                </span>
                                                            <% } %>
                                                            <% if (typeof usuario.totalPago === 'number' && usuario.totalPago > 0 && usuario.totalPagamentos > 1) { %>
                                                                <div class="text-xs text-blue-600 mt-1">
                                                                    Total: R$ <%= usuario.totalPago.toFixed(2).replace('.', ',') %>
                                                                </div>
                                                            <% } %>
                                                        <% } else { %>
                                                            <span class="text-gray-400 text-xs">
                                                                <i class="fas fa-times-circle mr-1"></i>Nunca pagou
                                                            </span>
                                                        <% } %>
                                                    </td>
                                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                                        <% if (usuario.last_login) { %>
                                                            <div class="text-gray-900">
                                                                <%= new
                                                                    Date(usuario.last_login).toLocaleDateString('pt-BR')
                                                                    %>
                                                            </div>
                                                            <div class="text-xs text-gray-400">
                                                                <%= new
                                                                    Date(usuario.last_login).toLocaleTimeString('pt-BR',
                                                                    { hour: '2-digit' , minute: '2-digit' }) %>
                                                            </div>
                                                            <% const ultimoLoginDate=new Date(usuario.last_login); const
                                                                hojeDate=new Date(); const diffDias=Math.floor((hojeDate
                                                                - ultimoLoginDate) / (1000 * 60 * 60 * 24)); %>
                                                                <div class="text-xs mt-1">
                                                                    <% if (diffDias===0) { %>
                                                                        <span class="text-green-600">Hoje</span>
                                                                        <% } else if (diffDias===1) { %>
                                                                            <span class="text-green-600">Ontem</span>
                                                                            <% } else if (diffDias <=7) { %>
                                                                                <span class="text-yellow-600">
                                                                                    <%= diffDias %> dias atrás
                                                                                </span>
                                                                                <% } else if (diffDias <=30) { %>
                                                                                    <span class="text-orange-600">
                                                                                        <%= diffDias %> dias atrás
                                                                                    </span>
                                                                                    <% } else { %>
                                                                                        <span class="text-red-600">
                                                                                            <%= diffDias %> dias atrás
                                                                                        </span>
                                                                                        <% } %>
                                                                </div>
                                                                <% } else { %>
                                                                    <span class="text-gray-400 text-xs">Nunca</span>
                                                                    <% } %>
                                                    </td>
                                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                                        <div class="flex space-x-2">
                                                            <a href="/admin/usuarios/<%= usuario.id %>"
                                                                class="text-blue-600 hover:text-blue-900"
                                                                title="Ver detalhes">
                                                                <i class="fas fa-eye"></i>
                                                            </a>
                                                            <% const usuarioAtivo=usuario.ativo !==false &&
                                                                usuario.ativo !=='false' && usuario.ativo !==null &&
                                                                usuario.ativo !==undefined; const
                                                                usuarioBloqueado=usuario.bloqueado===true ||
                                                                usuario.bloqueado==='true' ; const
                                                                ativoClass=usuarioAtivo
                                                                ? 'text-gray-600 hover:text-gray-900'
                                                                : 'text-green-600 hover:text-green-900' ; const
                                                                bloqueadoClass=usuarioBloqueado
                                                                ? 'text-green-600 hover:text-green-900'
                                                                : 'text-red-600 hover:text-red-900' ; const
                                                                novoValorAtivo=usuarioAtivo ? 'false' : 'true' ; const
                                                                novoValorBloqueado=usuarioBloqueado ? 'false' : 'true' ;
                                                                %>
                                                                <button
                                                                    onclick="toggleStatus('<%= usuario.id %>', 'ativo', '<%= novoValorAtivo %>')"
                                                                    class="<%= ativoClass %>"
                                                                    title="<%= usuarioAtivo ? 'Desativar' : 'Ativar' %>">
                                                                    <i
                                                                        class="fas fa-<%= usuarioAtivo ? 'ban' : 'check' %>"></i>
                                                                </button>
                                                                <button
                                                                    onclick="toggleStatus('<%= usuario.id %>', 'bloqueado', '<%= novoValorBloqueado %>')"
                                                                    class="<%= bloqueadoClass %>"
                                                                    title="<%= usuarioBloqueado ? 'Desbloquear' : 'Bloquear' %>">
                                                                    <i
                                                                        class="fas fa-<%= usuarioBloqueado ? 'unlock' : 'lock' %>"></i>
                                                                </button>
                                                                <button
                                                                    onclick="resetarSenha('<%= usuario.id %>', '<%= usuario.nome %>')"
                                                                    class="text-yellow-600 hover:text-yellow-900"
                                                                    title="Resetar senha">
                                                                    <i class="fas fa-key"></i>
                                                                </button>
                                                        </div>
                                                    </td>
                                                </tr>
                                                <% }); %>
                                                    <% } else { %>
                                                        <tr>
                                                            <td colspan="8" class="px-6 py-4 text-center text-gray-500">
                                                                Nenhum usuário encontrado
                                                            </td>
                                                        </tr>
                                                        <% } %>
                                    </tbody>
                                </table>
                            </div>

                            <script>
                                // Define CSRF token e função helper se não existirem
                                window.csrfToken = window.csrfToken || '<%= typeof csrfToken !== "undefined" && csrfToken ? csrfToken : "" %>';

                                function getCSRFHeaders() {
                                    const headers = { 'Content-Type': 'application/json' };
                                    if (window.csrfToken) {
                                        headers['x-csrf-token'] = window.csrfToken;
                                        headers['X-CSRF-Token'] = window.csrfToken;
                                        headers['csrf-token'] = window.csrfToken;
                                    }
                                    return headers;
                                }

                                async function toggleStatus(userId, campo, valor) {
                                    // Converte string para boolean se necessário
                                    const valorBool = valor === 'true' || valor === true;
                                    const acao = valorBool ? (campo === 'bloqueado' ? 'bloquear' : 'ativar') : (campo === 'bloqueado' ? 'desbloquear' : 'desativar');
                                    if (!confirm('Tem certeza que deseja ' + acao + ' este usuário?')) {
                                        return;
                                    }

                                    try {
                                        const headers = getCSRFHeaders();
                                        const body = { [campo]: valorBool };
                                        if (window.csrfToken) {
                                            body._csrf = window.csrfToken;
                                        }

                                        const response = await fetch('/admin/usuarios/' + userId + '/atualizar', {
                                            method: 'POST',
                                            headers: headers,
                                            body: JSON.stringify(body),
                                            credentials: 'same-origin'
                                        });

                                        if (!response.ok) {
                                            const errorText = await response.text();
                                            console.error('Erro HTTP:', response.status, errorText);
                                            throw new Error(`Erro ${response.status}: ${errorText || 'Resposta inválida do servidor'}`);
                                        }

                                        const data = await response.json();
                                        console.log('Resposta do servidor:', data);

                                        if (data.success) {
                                            alert('✅ ' + acao.charAt(0).toUpperCase() + acao.slice(1) + ' realizado com sucesso!');
                                            location.reload();
                                        } else {
                                            alert('❌ Erro: ' + (data.error || 'Erro ao atualizar usuário'));
                                            console.error('Erro na resposta:', data);
                                        }
                                    } catch (error) {
                                        console.error('Erro completo ao atualizar usuário:', error);
                                        alert('❌ Erro ao atualizar usuário: ' + error.message);
                                    }
                                }

                                function resetarSenha(userId, nome) {
                                    const novaSenha = prompt('Digite a nova senha para ' + nome + ':');
                                    if (!novaSenha || novaSenha.length < 6) {
                                        alert('Senha deve ter pelo menos 6 caracteres');
                                        return;
                                    }

                                    if (!confirm('Tem certeza que deseja alterar a senha de ' + nome + '?')) {
                                        return;
                                    }

                                    const headers = getCSRFHeaders();
                                    const body = { novaSenha: novaSenha };
                                    if (window.csrfToken) {
                                        body._csrf = window.csrfToken;
                                    }

                                    fetch('/admin/usuarios/' + userId + '/resetar-senha', {
                                        method: 'POST',
                                        headers: headers,
                                        body: JSON.stringify(body),
                                        credentials: 'same-origin'
                                    })
                                        .then(res => res.json())
                                        .then(data => {
                                            if (data.success) {
                                                alert('Senha alterada com sucesso!');
                                            } else {
                                                alert('Erro: ' + (data.error || 'Erro ao alterar senha'));
                                            }
                                        })
                                        .catch(error => {
                                            alert('Erro ao alterar senha');
                                            console.error(error);
                                        });
                                }
                            </script>
                </main>
</body>

</html>