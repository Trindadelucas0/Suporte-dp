<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>
        <%= title %>
    </title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: { red: '#DC2626', yellow: '#FBBF24' }
                    },
                    animation: {
                        'float': 'float 6s ease-in-out infinite',
                        'pulse-slow': 'pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'gradient': 'gradient 15s ease infinite',
                        'slide-up': 'slideUp 0.5s ease-out',
                        'fade-in': 'fadeIn 0.6s ease-out',
                    },
                    keyframes: {
                        float: {
                            '0%, 100%': { transform: 'translateY(0px)' },
                            '50%': { transform: 'translateY(-20px)' }
                        },
                        gradient: {
                            '0%, 100%': { backgroundPosition: '0% 50%' },
                            '50%': { backgroundPosition: '100% 50%' }
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(30px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' }
                        },
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' }
                        }
                    }
                }
            }
        }
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="/css/loading.css">
    <!-- Favicon com as letras "DP" nas cores do sistema (Vermelho #DC2626 e Amarelo #FBBF24) -->
    <link rel="icon" type="image/svg+xml"
        href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 200 200'%3E%3Cdefs%3E%3ClinearGradient id='grad' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%23DC2626;stop-opacity:1' /%3E%3Cstop offset='100%25' style='stop-color:%23FBBF24;stop-opacity:1' /%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='200' height='200' rx='20' fill='url(%23grad)'/%3E%3Ctext x='100' y='140' font-family='Arial, sans-serif' font-size='120' font-weight='bold' text-anchor='middle' fill='white'%3EDP%3C/text%3E%3C/svg%3E" />
    <link rel="apple-touch-icon"
        href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 200 200'%3E%3Cdefs%3E%3ClinearGradient id='grad' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%23DC2626;stop-opacity:1' /%3E%3Cstop offset='100%25' style='stop-color:%23FBBF24;stop-opacity:1' /%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='200' height='200' rx='20' fill='url(%23grad)'/%3E%3Ctext x='100' y='140' font-family='Arial, sans-serif' font-size='120' font-weight='bold' text-anchor='middle' fill='white'%3EDP%3C/text%3E%3C/svg%3E" />
    <style>
        * {
            font-family: 'Inter', sans-serif;
        }

        .glass {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .glass-dark {
            background: rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
        }

        .gradient-text {
            background: linear-gradient(135deg, #DC2626 0%, #FBBF24 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .dark-gradient-bg {
            background: linear-gradient(135deg, 
                #0a0a0a 0%, 
                #1a0a0a 25%, 
                #0a0a0a 50%, 
                #1a0a0a 75%, 
                #0a0a0a 100%
            );
        }

        .light-effects {
            position: absolute;
            inset: 0;
            background: 
                radial-gradient(
                    circle at 20% 30%, 
                    rgba(220, 38, 38, 0.08) 0%, 
                    transparent 50%
                ),
                radial-gradient(
                    circle at 80% 70%, 
                    rgba(251, 191, 36, 0.08) 0%, 
                    transparent 50%
                );
            pointer-events: none;
        }

        .icon-glow {
            filter: drop-shadow(0 0 10px rgba(220, 38, 38, 0.5));
        }

        .icon-glow-yellow {
            filter: drop-shadow(0 0 10px rgba(251, 191, 36, 0.5));
        }

        .input-glow:focus {
            box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.1), 0 0 20px rgba(220, 38, 38, 0.2);
        }

        .table-glass {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .table-row-hover:hover {
            background: rgba(255, 255, 255, 0.08);
            transition: all 0.2s ease;
        }
    </style>
</head>

<body class="dark-gradient-bg min-h-screen">
    <% if (typeof user !=='undefined' && user) { %>
        <%- include('../partials/navbar') %>
            <% } %>

                <main class="max-w-7xl mx-auto py-8 sm:px-6 lg:px-8 relative min-h-screen">
                    <!-- Background Effects -->
                    <div class="light-effects"></div>
                    <div class="absolute top-10 left-10 w-96 h-96 bg-primary-red/10 rounded-full blur-3xl animate-pulse-slow"></div>
                    <div class="absolute bottom-10 right-10 w-96 h-96 bg-primary-yellow/10 rounded-full blur-3xl animate-pulse-slow"
                        style="animation-delay: 2s;"></div>

                    <div class="relative z-10">
                        <!-- Header -->
                        <div class="mb-8 flex justify-between items-center animate-fade-in">
                            <div class="flex items-center space-x-4">
                                <div class="relative">
                                    <div
                                        class="absolute inset-0 bg-gradient-to-r from-primary-red to-primary-yellow rounded-2xl blur-xl opacity-50">
                                    </div>
                                    <div class="relative bg-gradient-to-r from-primary-red to-primary-yellow p-4 rounded-2xl">
                                        <i class="fas fa-users text-white text-4xl icon-glow"></i>
                                    </div>
                                </div>
                                <div>
                                    <h1 class="text-4xl font-black text-white">
                                        Gestão de <span class="gradient-text">Usuários</span>
                                    </h1>
                                    <p class="mt-2 text-white/70 text-sm font-medium">Visualize e gerencie todos os usuários do sistema</p>
                                </div>
                            </div>
                            <a href="/admin"
                                class="group relative bg-gradient-to-r from-gray-700 to-gray-800 text-white px-6 py-3 rounded-xl font-bold hover:shadow-2xl hover:shadow-gray-700/50 transition-all transform hover:scale-105 overflow-hidden">
                                <span class="relative z-10 flex items-center">
                                    <i class="fas fa-arrow-left mr-2"></i>Voltar
                                    <i class="fas fa-arrow-left ml-2 group-hover:-translate-x-1 transition-transform"></i>
                                </span>
                                <div
                                    class="absolute inset-0 bg-gradient-to-r from-gray-800 to-gray-700 opacity-0 group-hover:opacity-100 transition-opacity">
                                </div>
                            </a>
                        </div>

                        <% if (typeof error !=='undefined' && error) { %>
                            <div
                                class="glass-dark border-l-4 border-red-500 text-red-200 px-4 py-3 rounded-lg mb-6 flex items-start animate-slide-up">
                                <i class="fas fa-exclamation-circle mr-2 mt-0.5 flex-shrink-0"></i>
                                <div>
                                    <strong class="block">Erro:</strong>
                                    <span class="text-sm">
                                        <%= error %>
                                    </span>
                                </div>
                            </div>
                            <% } %>

                                <!-- Filtros -->
                                <div class="glass rounded-2xl shadow-2xl p-6 mb-6 border border-white/20 backdrop-blur-xl animate-slide-up">
                                    <div class="flex flex-wrap gap-3">
                                        <% const filtroAtivoParam=typeof filtroAtivo !=='undefined' ? filtroAtivo : null; %>
                                            <% const filtroBloqueadoParam=typeof filtroBloqueado !=='undefined' ?
                                                filtroBloqueado : null; %>
                                                <a href="/admin/usuarios"
                                                    class="px-5 py-2.5 rounded-xl font-semibold transition-all transform hover:scale-105 <%= !filtroAtivoParam && !filtroBloqueadoParam ? 'bg-gradient-to-r from-primary-red to-primary-yellow text-white shadow-lg shadow-primary-red/50' : 'glass text-white/90 hover:text-white hover:bg-white/20' %>">
                                                    <i class="fas fa-list mr-2"></i>Todos
                                                </a>
                                                <a href="/admin/usuarios?ativo=true"
                                                    class="px-5 py-2.5 rounded-xl font-semibold transition-all transform hover:scale-105 <%= filtroAtivoParam === 'true' ? 'bg-gradient-to-r from-green-500 to-green-600 text-white shadow-lg shadow-green-500/50' : 'glass text-white/90 hover:text-white hover:bg-white/20' %>"
                                                    title="Usuários que pagaram">
                                                    <i class="fas fa-check-circle mr-2"></i>Ativos (Pagaram)
                                                </a>
                                                <a href="/admin/usuarios?ativo=false"
                                                    class="px-5 py-2.5 rounded-xl font-semibold transition-all transform hover:scale-105 <%= filtroAtivoParam === 'false' ? 'bg-gradient-to-r from-yellow-500 to-yellow-600 text-white shadow-lg shadow-yellow-500/50' : 'glass text-white/90 hover:text-white hover:bg-white/20' %>"
                                                    title="Usuários que não renovaram">
                                                    <i class="fas fa-exclamation-triangle mr-2"></i>Inativos (Não Renovaram)
                                                </a>
                                                <a href="/admin/usuarios?bloqueado=true"
                                                    class="px-5 py-2.5 rounded-xl font-semibold transition-all transform hover:scale-105 <%= filtroBloqueadoParam === 'true' ? 'bg-gradient-to-r from-red-600 to-red-700 text-white shadow-lg shadow-red-600/50' : 'glass text-white/90 hover:text-white hover:bg-white/20' %>"
                                                    title="Usuários bloqueados de acessar">
                                                    <i class="fas fa-lock mr-2"></i>Bloqueados
                                                </a>
                                    </div>
                                </div>

                                <!-- Tabela de Usuários -->
                                <div class="glass rounded-2xl shadow-2xl overflow-hidden border border-white/20 backdrop-blur-xl animate-slide-up"
                                    style="animation-delay: 0.1s;">
                                    <div class="overflow-x-auto">
                                        <table class="min-w-full divide-y divide-white/10">
                                            <thead class="table-glass">
                                                <tr>
                                                    <th
                                                        class="px-6 py-4 text-left text-xs font-bold text-white/90 uppercase tracking-wider">
                                                        <i class="fas fa-user mr-2 text-primary-yellow"></i>Usuário</th>
                                                    <th
                                                        class="px-6 py-4 text-left text-xs font-bold text-white/90 uppercase tracking-wider">
                                                        <i class="fas fa-envelope mr-2 text-primary-yellow"></i>Email / <i class="fab fa-whatsapp mr-2 text-green-400"></i>WhatsApp</th>
                                                    <th
                                                        class="px-6 py-4 text-left text-xs font-bold text-white/90 uppercase tracking-wider">
                                                        <i class="fas fa-info-circle mr-2 text-primary-yellow"></i>Status</th>
                                                    <th
                                                        class="px-6 py-4 text-left text-xs font-bold text-white/90 uppercase tracking-wider">
                                                        <i class="fas fa-credit-card mr-2 text-primary-yellow"></i>Pagamento</th>
                                                    <th
                                                        class="px-6 py-4 text-left text-xs font-bold text-white/90 uppercase tracking-wider">
                                                        <i class="fas fa-star mr-2 text-primary-yellow"></i>Assinatura</th>
                                                    <th
                                                        class="px-6 py-4 text-left text-xs font-bold text-white/90 uppercase tracking-wider">
                                                        <i class="fas fa-money-bill-wave mr-2 text-primary-yellow"></i>Último Pagamento</th>
                                                    <th
                                                        class="px-6 py-4 text-left text-xs font-bold text-white/90 uppercase tracking-wider">
                                                        <i class="fas fa-sign-in-alt mr-2 text-primary-yellow"></i>Último Login</th>
                                                    <th
                                                        class="px-6 py-4 text-left text-xs font-bold text-white/90 uppercase tracking-wider">
                                                        <i class="fas fa-cog mr-2 text-primary-yellow"></i>Ações</th>
                                                </tr>
                                            </thead>
                                            <tbody class="divide-y divide-white/10">
                                                <% if (usuarios && usuarios.length> 0) { %>
                                                    <% usuarios.forEach((usuario, index)=> { %>
                                                        <tr class="table-row-hover" style="animation-delay: <%= (index * 0.05) %>s;">
                                                            <td class="px-6 py-4 whitespace-nowrap">
                                                                <div class="flex items-center">
                                                                    <div
                                                                        class="flex-shrink-0 h-12 w-12 rounded-full bg-gradient-to-r from-primary-red to-primary-yellow flex items-center justify-center text-white font-bold text-lg shadow-lg">
                                                                        <%= usuario.nome.charAt(0).toUpperCase() %>
                                                                    </div>
                                                                    <div class="ml-4">
                                                                        <div class="text-sm font-bold text-white">
                                                                            <%= usuario.nome %>
                                                                                <% if (usuario.is_admin) { %>
                                                                                    <span
                                                                                        class="ml-2 px-2 py-1 text-xs bg-gradient-to-r from-purple-500 to-purple-600 text-white rounded-full font-semibold">
                                                                                        <i class="fas fa-crown mr-1"></i>Admin</span>
                                                                                    <% } %>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </td>
                                                            <td class="px-6 py-4">
                                                                <div class="flex flex-col space-y-2">
                                                                    <div class="flex items-center text-sm font-medium text-white">
                                                                        <i class="fas fa-envelope text-primary-yellow mr-2 flex-shrink-0"></i>
                                                                        <span class="truncate max-w-xs" title="<%= usuario.email %>"><%= usuario.email %></span>
                                                                    </div>
                                                                    <% if (usuario.whatsapp) { %>
                                                                        <div class="flex items-center text-xs text-white/80">
                                                                            <i class="fab fa-whatsapp text-green-400 mr-2 flex-shrink-0"></i>
                                                                            <span class="truncate max-w-xs" title="<%= usuario.whatsapp %>"><%= usuario.whatsapp %></span>
                                                                        </div>
                                                                        <% } else { %>
                                                                            <div class="flex items-center text-xs text-white/40 italic">
                                                                                <i class="fab fa-whatsapp text-white/20 mr-2 flex-shrink-0"></i>
                                                                                <span>Sem WhatsApp</span>
                                                                            </div>
                                                                            <% } %>
                                                                </div>
                                                            </td>
                                                            <td class="px-6 py-4 whitespace-nowrap">
                                                                <% 
                                                                    // Nova lógica de status
                                                                    const isBloqueado = usuario.isBloqueado || usuario.bloqueado === true || usuario.bloqueado === 'true';
                                                                    const isAtivo = usuario.isAtivo || (!isBloqueado && (usuario.is_admin || usuario.temPagamentoAtivo));
                                                                    const isInativo = usuario.isInativo || (!isBloqueado && !usuario.is_admin && !usuario.temPagamentoAtivo);
                                                                %>
                                                                <% if (isBloqueado) { %>
                                                                    <span
                                                                        class="px-3 py-1.5 text-xs font-bold rounded-full bg-gradient-to-r from-red-500 to-red-600 text-white shadow-lg flex items-center justify-center w-fit">
                                                                        <i class="fas fa-lock mr-1.5"></i>Bloqueado</span>
                                                                    <% } else if (isInativo) { %>
                                                                        <span
                                                                            class="px-3 py-1.5 text-xs font-bold rounded-full bg-gradient-to-r from-yellow-500 to-yellow-600 text-white shadow-lg flex items-center justify-center w-fit">
                                                                            <i class="fas fa-exclamation-triangle mr-1.5"></i>Não Renovou</span>
                                                                        <% } else if (isAtivo) { %>
                                                                            <span
                                                                                class="px-3 py-1.5 text-xs font-bold rounded-full bg-gradient-to-r from-green-500 to-green-600 text-white shadow-lg flex items-center justify-center w-fit">
                                                                                <i class="fas fa-check-circle mr-1.5"></i>Pagou</span>
                                                                            <% } else { %>
                                                                                <span
                                                                                    class="px-3 py-1.5 text-xs font-bold rounded-full bg-gradient-to-r from-gray-500 to-gray-600 text-white shadow-lg flex items-center justify-center w-fit">
                                                                                    <i class="fas fa-question-circle mr-1.5"></i>Indefinido</span>
                                                                                <% } %>
                                                            </td>
                                                            <!-- COLUNA: STATUS DE PAGAMENTO -->
                                                            <td class="px-6 py-4 whitespace-nowrap">
                                                                <% if (usuario.is_admin) { %>
                                                                    <span
                                                                        class="px-3 py-1 text-xs font-bold rounded-full bg-gradient-to-r from-purple-500 to-purple-600 text-white shadow-lg">
                                                                        <i class="fas fa-user-shield mr-1"></i>Admin</span>
                                                                    <% } else if (usuario.temPagamentoAtivo) { %>
                                                                        <span
                                                                            class="px-3 py-1 text-xs font-bold rounded-full bg-gradient-to-r from-green-500 to-green-600 text-white shadow-lg">
                                                                            <i class="fas fa-check-circle mr-1"></i>Pago</span>
                                                                        <% if (typeof usuario.diasRestantes==='number' ) { %>
                                                                            <div class="text-xs text-white/80 mt-1.5 font-medium">
                                                                                <%= usuario.diasRestantes %> dia<%=
                                                                                        usuario.diasRestantes !==1 ? 's' : '' %>
                                                                                        restante<%= usuario.diasRestantes !==1
                                                                                            ? 's' : '' %>
                                                                            </div>
                                                                            <% } %>
                                                                                <% } else if (usuario.ultimoPagamento &&
                                                                                    usuario.estaExpirado) { %>
                                                                                    <span
                                                                                        class="px-3 py-1 text-xs font-bold rounded-full bg-gradient-to-r from-red-500 to-red-600 text-white shadow-lg">
                                                                                        <i class="fas fa-times-circle mr-1"></i>Expirado</span>
                                                                                    <% if (typeof
                                                                                        usuario.diasRestantes==='number' ) { %>
                                                                                        <div class="text-xs text-red-300 mt-1.5 font-medium">
                                                                                            <%= Math.abs(usuario.diasRestantes)
                                                                                                %> dia<%=
                                                                                                    Math.abs(usuario.diasRestantes)
                                                                                                    !==1 ? 's' : '' %> atrás
                                                                                        </div>
                                                                                        <% } %>
                                                                                            <% } else if
                                                                                                (usuario.ultimoPagamento &&
                                                                                                !usuario.temPagamentoAtivo &&
                                                                                                typeof
                                                                                                usuario.diasRestantes==='number'
                                                                                                && usuario.diasRestantes <=7) {
                                                                                                %>
                                                                                                <span
                                                                                                    class="px-3 py-1 text-xs font-bold rounded-full bg-gradient-to-r from-yellow-500 to-yellow-600 text-white shadow-lg">
                                                                                                    <i class="fas fa-exclamation-triangle mr-1"></i>Vencendo</span>
                                                                                                <div class="text-xs text-yellow-300 mt-1.5 font-medium">
                                                                                                    <%= usuario.diasRestantes %>
                                                                                                        dia<%=
                                                                                                            usuario.diasRestantes
                                                                                                            !==1 ? 's' : '' %>
                                                                                                            restante<%=
                                                                                                                usuario.diasRestantes
                                                                                                                !==1 ? 's' : ''
                                                                                                                %>
                                                                                                </div>
                                                                                                <% } else { %>
                                                                                                    <span
                                                                                                        class="px-3 py-1 text-xs font-bold rounded-full bg-gradient-to-r from-gray-500 to-gray-600 text-white shadow-lg">
                                                                                                        <i class="fas fa-times mr-1"></i>Não Pago</span>
                                                                                                    <div class="text-xs text-white/50 mt-1.5">
                                                                                                        Sem pagamento</div>
                                                                                                    <% } %>
                                                            </td>
                                                            <!-- COLUNA: ASSINATURA -->
                                                            <td class="px-6 py-4 whitespace-nowrap">
                                                                <% const subscriptionStatus=usuario.subscription_status || 'N/A'
                                                                    ; %>
                                                                    <% if (subscriptionStatus==='ativa' ) { %>
                                                                        <span
                                                                            class="px-3 py-1 text-xs font-bold rounded-full bg-gradient-to-r from-green-500 to-green-600 text-white shadow-lg">
                                                                            <i class="fas fa-star mr-1"></i>Ativa</span>
                                                                        <% } else if (subscriptionStatus==='inadimplente' ) { %>
                                                                            <span
                                                                                class="px-3 py-1 text-xs font-bold rounded-full bg-gradient-to-r from-red-500 to-red-600 text-white shadow-lg">
                                                                                <i class="fas fa-exclamation-circle mr-1"></i>Inadimplente</span>
                                                                            <% } else { %>
                                                                                <span
                                                                                    class="px-3 py-1 text-xs font-bold rounded-full bg-gradient-to-r from-gray-500 to-gray-600 text-white shadow-lg">
                                                                                    <%= subscriptionStatus %>
                                                                                </span>
                                                                                <% } %>
                                                                                    <% if (usuario.subscription_expires_at) { %>
                                                                                        <div class="text-xs text-white/70 mt-1.5">
                                                                                            <i class="fas fa-calendar mr-1"></i>
                                                                                            Expira: <%= new
                                                                                                Date(usuario.subscription_expires_at).toLocaleDateString('pt-BR')
                                                                                                %>
                                                                                        </div>
                                                                                        <% } %>
                                                                                            <% if (typeof
                                                                                                usuario.totalPagamentos==='number'
                                                                                                && usuario.totalPagamentos> 0) {
                                                                                                %>
                                                                                                <div class="text-xs text-white/50 mt-1">
                                                                                                    <%= usuario.totalPagamentos
                                                                                                        %> pagamento<%=
                                                                                                            usuario.totalPagamentos
                                                                                                            !==1 ? 's' : '' %>
                                                                                                            no total
                                                                                                </div>
                                                                                                <% } %>
                                                            </td>
                                                            <td class="px-6 py-4 whitespace-nowrap text-sm">
                                                                <% if (usuario.ultimoPagamento) { %>
                                                                    <div class="font-bold text-green-400">
                                                                        <i class="fas fa-money-bill-wave mr-1"></i>
                                                                        R$ <%= parseFloat(usuario.ultimoPagamento.paid_amount ||
                                                                            0).toFixed(2).replace('.', ',' ) %>
                                                                    </div>
                                                                    <div class="text-xs text-white/70 mt-1">
                                                                        <i class="fas fa-calendar mr-1"></i>
                                                                        <%= new
                                                                            Date(usuario.ultimoPagamento.paid_at).toLocaleDateString('pt-BR')
                                                                            %>
                                                                    </div>
                                                                    <div class="text-xs text-white/50 mt-1">
                                                                        Método: <%= usuario.ultimoPagamento.capture_method
                                                                            || 'N/A' %>
                                                                    </div>
                                                                    <% if (usuario.ultimoPagamento.status==='paid' ) { %>
                                                                        <span
                                                                            class="inline-block mt-1.5 px-2 py-0.5 text-xs font-bold rounded-full bg-gradient-to-r from-green-500 to-green-600 text-white">
                                                                            <i class="fas fa-check mr-1"></i>Confirmado</span>
                                                                        <% } else { %>
                                                                            <span
                                                                                class="inline-block mt-1.5 px-2 py-0.5 text-xs font-bold rounded-full bg-gradient-to-r from-yellow-500 to-yellow-600 text-white">
                                                                                <%= usuario.ultimoPagamento.status || 'Pendente'
                                                                                    %>
                                                                            </span>
                                                                            <% } %>
                                                                                <% if (typeof usuario.totalPago==='number' &&
                                                                                    usuario.totalPago> 0 &&
                                                                                    usuario.totalPagamentos > 1) { %>
                                                                                    <div class="text-xs text-blue-400 mt-1 font-medium">
                                                                                        Total: R$ <%
                                                                                            usuario.totalPago.toFixed(2).replace('.', ','
                                                                                            ) %>
                                                                                    </div>
                                                                                    <% } %>
                                                                                        <% } else { %>
                                                                                            <span class="text-white/50 text-xs">
                                                                                                <i class="fas fa-times-circle mr-1"></i>Nunca pagou</span>
                                                                                            <% } %>
                                                            </td>
                                                            <td class="px-6 py-4 whitespace-nowrap text-sm">
                                                                <% if (usuario.last_login) { %>
                                                                    <div class="text-white font-medium">
                                                                        <%= new
                                                                            Date(usuario.last_login).toLocaleDateString('pt-BR')
                                                                            %>
                                                                    </div>
                                                                    <div class="text-xs text-white/70">
                                                                        <%= new
                                                                            Date(usuario.last_login).toLocaleTimeString('pt-BR',
                                                                            { hour: '2-digit' , minute: '2-digit' }) %>
                                                                    </div>
                                                                    <% const ultimoLoginDate=new Date(usuario.last_login); const
                                                                        hojeDate=new Date(); const diffDias=Math.floor((hojeDate
                                                                        - ultimoLoginDate) / (1000 * 60 * 60 * 24)); %>
                                                                        <div class="text-xs mt-1.5 font-medium">
                                                                            <% if (diffDias===0) { %>
                                                                                <span class="text-green-400"><i class="fas fa-circle mr-1 text-xs"></i>Hoje</span>
                                                                                <% } else if (diffDias===1) { %>
                                                                                    <span class="text-green-400"><i class="fas fa-circle mr-1 text-xs"></i>Ontem</span>
                                                                                    <% } else if (diffDias <=7) { %>
                                                                                        <span class="text-yellow-400">
                                                                                            <i class="fas fa-circle mr-1 text-xs"></i><%= diffDias %> dias atrás
                                                                                        </span>
                                                                                        <% } else if (diffDias <=30) { %>
                                                                                            <span class="text-orange-400">
                                                                                                <i class="fas fa-circle mr-1 text-xs"></i><%= diffDias %> dias atrás
                                                                                            </span>
                                                                                            <% } else { %>
                                                                                                <span class="text-red-400">
                                                                                                    <i class="fas fa-circle mr-1 text-xs"></i><%= diffDias %> dias atrás
                                                                                                </span>
                                                                                                <% } %>
                                                                        </div>
                                                                        <% } else { %>
                                                                            <span class="text-white/50 text-xs">Nunca</span>
                                                                            <% } %>
                                                            </td>
                                                            <td class="px-6 py-4 whitespace-nowrap">
                                                                <div class="flex items-center space-x-3">
                                                                    <!-- Ver Detalhes -->
                                                                    <a href="/admin/usuarios/<%= usuario.id %>"
                                                                        class="group relative p-2.5 rounded-xl bg-blue-500/20 hover:bg-blue-500/30 text-blue-400 hover:text-blue-300 transition-all transform hover:scale-110 border border-blue-500/30 hover:border-blue-500/50"
                                                                        title="Ver detalhes do usuário">
                                                                        <i class="fas fa-eye text-base"></i>
                                                                        <span class="absolute -top-8 left-1/2 transform -translate-x-1/2 bg-gray-900 text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap z-50">
                                                                            Ver Detalhes
                                                                        </span>
                                                                    </a>
                                                                    <% 
                                                                        // Determina estados para ações
                                                                        const usuarioBloqueado = usuario.isBloqueado || usuario.bloqueado === true || usuario.bloqueado === 'true';
                                                                        const novoValorBloqueado = usuarioBloqueado ? 'false' : 'true';
                                                                    %>
                                                                    <!-- Bloquear/Desbloquear -->
                                                                    <button
                                                                        onclick="toggleStatus('<%= usuario.id %>', 'bloqueado', '<%= novoValorBloqueado %>')"
                                                                        class="group relative p-2.5 rounded-xl <%= usuarioBloqueado ? 'bg-green-500/20 hover:bg-green-500/30 text-green-400 hover:text-green-300 border-green-500/30 hover:border-green-500/50' : 'bg-red-500/20 hover:bg-red-500/30 text-red-400 hover:text-red-300 border-red-500/30 hover:border-red-500/50' %> transition-all transform hover:scale-110 border"
                                                                        title="<%= usuarioBloqueado ? 'Desbloquear usuário' : 'Bloquear usuário' %>">
                                                                        <i class="fas fa-<%= usuarioBloqueado ? 'unlock' : 'lock' %> text-base"></i>
                                                                        <span class="absolute -top-8 left-1/2 transform -translate-x-1/2 bg-gray-900 text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap z-50">
                                                                            <%= usuarioBloqueado ? 'Desbloquear' : 'Bloquear' %>
                                                                        </span>
                                                                    </button>
                                                                    <!-- Resetar Senha -->
                                                                    <button
                                                                        onclick="resetarSenha('<%= usuario.id %>', '<%= usuario.nome %>')"
                                                                        class="group relative p-2.5 rounded-xl bg-yellow-500/20 hover:bg-yellow-500/30 text-yellow-400 hover:text-yellow-300 transition-all transform hover:scale-110 border border-yellow-500/30 hover:border-yellow-500/50"
                                                                        title="Resetar senha do usuário">
                                                                        <i class="fas fa-key text-base"></i>
                                                                        <span class="absolute -top-8 left-1/2 transform -translate-x-1/2 bg-gray-900 text-white text-xs px-2 py-1 rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap z-50">
                                                                            Resetar Senha
                                                                        </span>
                                                                    </button>
                                                                </div>
                                                            </td>
                                                        </tr>
                                                        <% }); %>
                                                            <% } else { %>
                                                                <tr>
                                                                    <td colspan="8" class="px-6 py-12 text-center">
                                                                        <div class="flex flex-col items-center">
                                                                            <i class="fas fa-users text-6xl text-white/30 mb-4"></i>
                                                                            <p class="text-white/70 text-lg font-medium">Nenhum usuário encontrado</p>
                                                                        </div>
                                                                    </td>
                                                                </tr>
                                                                <% } %>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                    </div>
                </main>

                <script src="/js/loading.js"></script>
                <script>
                    // Define CSRF token e função helper se não existirem
                    window.csrfToken = window.csrfToken || '<%= typeof csrfToken !== "undefined" && csrfToken ? csrfToken : "" %>';

                    function getCSRFHeaders() {
                        const headers = { 'Content-Type': 'application/json' };
                        if (window.csrfToken) {
                            headers['x-csrf-token'] = window.csrfToken;
                            headers['X-CSRF-Token'] = window.csrfToken;
                            headers['csrf-token'] = window.csrfToken;
                        }
                        return headers;
                    }

                    async function toggleStatus(userId, campo, valor) {
                        // Converte string para boolean se necessário
                        const valorBool = valor === 'true' || valor === true;
                        const acao = valorBool ? (campo === 'bloqueado' ? 'bloquear' : 'ativar') : (campo === 'bloqueado' ? 'desbloquear' : 'desativar');
                        if (!confirm('Tem certeza que deseja ' + acao + ' este usuário?')) {
                            return;
                        }

                        showLoading('Atualizando usuário...');

                        try {
                            const headers = getCSRFHeaders();
                            const body = { [campo]: valorBool };
                            if (window.csrfToken) {
                                body._csrf = window.csrfToken;
                            }

                            const response = await fetch('/admin/usuarios/' + userId + '/atualizar', {
                                method: 'POST',
                                headers: headers,
                                body: JSON.stringify(body),
                                credentials: 'same-origin'
                            });

                            if (!response.ok) {
                                const errorText = await response.text();
                                console.error('Erro HTTP:', response.status, errorText);
                                throw new Error(`Erro ${response.status}: ${errorText || 'Resposta inválida do servidor'}`);
                            }

                            const data = await response.json();
                            console.log('Resposta do servidor:', data);

                            hideLoading();

                            if (data.success) {
                                alert('✅ ' + acao.charAt(0).toUpperCase() + acao.slice(1) + ' realizado com sucesso!');
                                location.reload();
                            } else {
                                alert('❌ Erro: ' + (data.error || 'Erro ao atualizar usuário'));
                                console.error('Erro na resposta:', data);
                            }
                        } catch (error) {
                            hideLoading();
                            console.error('Erro completo ao atualizar usuário:', error);
                            alert('❌ Erro ao atualizar usuário: ' + error.message);
                        }
                    }

                    function resetarSenha(userId, nome) {
                        const novaSenha = prompt('Digite a nova senha para ' + nome + ':');
                        if (!novaSenha) {
                            return; // Usuário cancelou
                        }

                        if (novaSenha.length < 6) {
                            alert('❌ Senha deve ter pelo menos 6 caracteres');
                            return;
                        }

                        if (!confirm('Tem certeza que deseja alterar a senha de ' + nome + '?')) {
                            return;
                        }

                        showLoading('Alterando senha...');

                        const headers = getCSRFHeaders();
                        const body = { 
                            novaSenha: novaSenha
                        };
                        
                        // Adiciona CSRF token no body e headers
                        if (window.csrfToken) {
                            body._csrf = window.csrfToken;
                        }

                        console.log('🔐 [FRONTEND] Resetando senha:', {
                            userId: userId,
                            temToken: !!window.csrfToken,
                            headers: headers
                        });

                        fetch('/admin/usuarios/' + userId + '/resetar-senha', {
                            method: 'POST',
                            headers: headers,
                            body: JSON.stringify(body),
                            credentials: 'same-origin'
                        })
                            .then(async res => {
                                console.log('📥 [FRONTEND] Resposta recebida:', res.status, res.statusText);
                                
                                // Tenta parsear como JSON
                                let data;
                                try {
                                    const text = await res.text();
                                    console.log('📄 [FRONTEND] Resposta texto:', text);
                                    data = text ? JSON.parse(text) : {};
                                } catch (e) {
                                    console.error('❌ [FRONTEND] Erro ao parsear JSON:', e);
                                    data = { success: false, error: 'Resposta inválida do servidor' };
                                }

                                hideLoading();
                                
                                if (data.success) {
                                    alert('✅ Senha alterada com sucesso!');
                                } else {
                                    alert('❌ Erro: ' + (data.error || 'Erro ao alterar senha'));
                                }
                            })
                            .catch(error => {
                                hideLoading();
                                console.error('❌ [FRONTEND] Erro completo:', error);
                                alert('❌ Erro ao alterar senha: ' + error.message);
                            });
                    }
                </script>
</body>

</html>
